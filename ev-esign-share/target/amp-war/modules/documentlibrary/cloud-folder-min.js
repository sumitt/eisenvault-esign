(function(){var d=YAHOO.util.Dom,j=YAHOO.util.Event;Alfresco.module.DoclibCloudFolder=function(o){Alfresco.module.DoclibCloudFolder.superclass.constructor.call(this,o);this.name="Alfresco.module.DoclibCloudFolder";Alfresco.util.ComponentManager.reregister(this);this.options=YAHOO.lang.merge(this.options,{allowedViewModes:[Alfresco.module.DoclibGlobalFolder.VIEW_MODE_SITE],targetNetwork:"-default-",targetUserid:"",templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/cloud-folder",sitesAPITemplate:Alfresco.constants.PROXY_URI+"cloud/people/{userid}/sites?network={network}",containersAPITemplate:Alfresco.constants.PROXY_URI+"cloud/doclib/containers/?network={network}",treeNodeAPITemplate:"cloud/doclib/treenode/site/{site}/{container}{path}?children={evaluateChildFoldersSite}&max={maximumFolderCountSite}&network={network}",templateFailMessage:Alfresco.util.message("message.sync.unavailable"),syncOptions:{},showSyncOptions:true,mode:"sync"});this.updateAPIURLs();if(o!="null"){try{YAHOO.Bubbling.unsubscribe("networkSelected",null,this);YAHOO.Bubbling.unsubscribe("authDetailsAvailable",null,this)}catch(p){}YAHOO.Bubbling.on("networkSelected",this._populateSitePicker,this);YAHOO.Bubbling.on("authDetailsAvailable",this.onAuthDetailsAvailable,this)}return this};YAHOO.extend(Alfresco.module.DoclibCloudFolder,Alfresco.module.DoclibGlobalFolder,{onTemplateLoaded:function k(o){if(o.serverResponse.status===204){Alfresco.util.PopupManager.displayMessage({text:this.msg("sync.message.no.active.network")})}else{Alfresco.module.DoclibCloudFolder.superclass.onTemplateLoaded.call(this,o)}},_selectionIncludesFolder:function a(){var p=this.options.files;if(YAHOO.lang.isArray(p)){for(var o in p){if(p[o].jsNode.isContainer){return true}}return false}else{return p.jsNode.isContainer}},_beforeShowDialog:function b(){Alfresco.module.DoclibCloudFolder.superclass._beforeShowDialog.call(this);if(!this.options.showSyncOptions){var p=d.getElementsByClassName("cloud-options","div",this.id+"-wrapper");d.addClass(p[0],"hidden")}this.widgets.optionInputs=d.getElementsByClassName("cloudSyncOption","input",this.id+"-wrapper");var q=this.widgets.optionInputs;for(var o in q){if(!this._selectionIncludesFolder()&&q[o].id==="includeSubFolders"){d.addClass(d.get(q[o].id+"-label"),"hidden");break}else{if(d.hasClass(d.get(q[o].id+"-label"),"hidden")){d.removeClass(d.get(q[o].id+"-label"),"hidden");break}}}},_showDialog:function m(){Alfresco.module.DoclibCloudFolder.superclass._showDialog.call(this);if(!this.widgets.networkButtons){this.widgets.networkButtons=new YAHOO.widget.ButtonGroup(this.id+"-networkGroup");this.widgets.networkButtons.on("checkedButtonChange",this.onNetworkSelect,this.widgets.networkButtons,this)}this.onNetworkSelect(null,this.widgets.networkButtons);var o=d.getElementsByClassName("cloud-path-add-folder","div");j.removeListener(o,"click");j.on(o,"click",function p(q){j.preventDefault(q);this.createFolderInTheCloud()},{},this)},createFolderInTheCloud:function h(){if(!this.widgets.createFolderInTheCloudDialog){var o=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&formId={formId}&showCancelButton=true",{itemKind:"type",itemId:"cm:folder",mode:"create",submitType:"json",formId:"doclib-common"});var v=function s(x,y){d.get(y.id+"-dialogTitle").innerHTML=this.msg("sync.new-folder.in-the-cloud.title");d.get(y.id+"-dialogHeader").innerHTML=this.msg("sync.new-folder.in-the-cloud.header")};var p=function w(x){this.widgets.cancelButton.set("disabled",false)};var u=function q(x){delete this.widgets.createFolderInTheCloudDialog};var r=function t(D){var E=(this.selectedNode.data.nodeRef).replace(":/","");var z="";var C=this.widgets.networkButtons.getButtons();for(var A in C){if(C[A].get("checked")){z=C[A]._button.innerHTML;break}}var y=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"cloud/node/folder/{destination}?network={network}",{destination:E,network:z});var x={name:D.dataObj.prop_cm_name,title:D.dataObj.prop_cm_title,description:D.dataObj.prop_cm_description};Alfresco.util.Ajax.jsonPost({url:y,dataObj:x,successCallback:{fn:function B(G){this.widgets.createFolderInTheCloudDialog.hide();Alfresco.util.PopupManager.displayMessage({text:this.msg("sync.new-folder.creation.success"),displayTime:0.5});var K="/";var L=this.selectedNode.data.path.split(K);L=Alfresco.util.arrayRemove(L,"");L.push(G.config.dataObj.name);var J="";this.pathsToExpand=[];for(var I=0,H=L.length;I<H;I++){J+=K+L[I];this.pathsToExpand.push(J)}YAHOO.Bubbling.fire("siteChanged",{site:this.options.siteId,siteTitle:this.options.siteTitle,eventGroup:this,scrollTo:true})},scope:this},failureCallback:{fn:function F(G){Alfresco.util.PopupManager.displayMessage({text:this.msg("sync.new-folder.creation.failure")});this.widgets.createFolderInTheCloudDialog.widgets.okButton.set("disabled",false)},scope:this}})};this.widgets.createFolderInTheCloudDialog=new Alfresco.module.SimpleDialog(this.id+"-createFolderInTheCloud");this.widgets.createFolderInTheCloudDialog.setOptions({width:"33em",templateUrl:o,actionUrl:null,clearForm:true,destroyOnHide:false,doBeforeFormSubmit:{fn:p,scope:this},doBeforeDialogShow:{fn:v,scope:this},doBeforeAjaxRequest:{fn:r,scope:this},doAfterDialogHide:{fn:u,scope:this}})}this.widgets.createFolderInTheCloudDialog.show()},setViewMode:function i(o){this.options.viewMode=o;d.removeClass(this.id+"-wrapper","repository-mode")},onNetworkSelect:function f(p,o){this.options.targetNetwork=o.get("checkedButton").get("name");this.updateAPIURLs();this.options.siteId=null;YAHOO.Bubbling.fire("networkSelected")},updateAPIURLs:function c(){var o={network:this.options.targetNetwork,userid:this.options.targetUserid};this.options.sitesAPI=YAHOO.lang.substitute(this.options.sitesAPITemplate,o);this.options.peopleAPI=YAHOO.lang.substitute(this.options.sitesAPITemplate,o);this.options.containersAPI=YAHOO.lang.substitute(this.options.containersAPITemplate,o);this.options.siteTreeContainerTypes={"cm:folder":{uri:YAHOO.lang.substitute(this.options.treeNodeAPITemplate,o)}}},updateSyncOptions:function g(){for(var o=0;o<this.widgets.optionInputs.length;o++){var q=d.getAttribute(this.widgets.optionInputs[o],"value"),p=d.getAttribute(this.widgets.optionInputs[o],"checked");this.options.syncOptions[q]=p}},onExpandComplete:function e(q){var p=d.getElementsByClassName("cloud-path-add-folder","div")[0];if(q.data.userAccess.create){p.style.display="block"}else{p.style.display="none"}if(this.pathsToExpand!=null){var o=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(o!=null){o.expand();this._updateSelectedNode(o)}}},onAuthDetailsAvailable:function n(p,o){this.options.targetUserid=o[1].authDetails.username}});var l=new Alfresco.module.DoclibCloudFolder("null")})();