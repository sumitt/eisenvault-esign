(function(){var b=YAHOO.util.Dom,q=YAHOO.util.Event,j=YAHOO.util.Element;var k=Alfresco.util.encodeHTML;Alfresco.SiteGroups=function(s){this.name="Alfresco.SiteGroups";this.id=s;this.widgets={};this.listWidgets={};this.buttons=[];this.modules={};this.isCurrentUserSiteAdmin=false;Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","datasource","datatable","json"],this.onComponentsLoaded,this);YAHOO.Bubbling.on("deactivateAllControls",this.onDeactivateAllControls,this);return this};Alfresco.SiteGroups.prototype={options:{siteId:"",minSearchTermLength:0,maxSearchResults:100,currentUser:"",currentUserRole:"",roles:[],error:null,setFocus:false},widgets:null,listWidgets:null,buttons:null,modules:null,isCurrentUserSiteAdmin:null,isSearching:false,setOptions:function m(s){this.options=YAHOO.lang.merge(this.options,s);return this},setMessages:function r(s){Alfresco.util.addMessages(s,this.name);return this},onComponentsLoaded:function d(){q.onContentReady(this.id,this.onReady,this,true)},onReady:function g(){var v=this;var u=Alfresco.constants.PROXY_URI+"api/sites/"+v.options.siteId+"/memberships?";this.widgets.dataSource=new YAHOO.util.DataSource(u,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items"}});this.widgets.dataSource.doBeforeParseData=function w(C,B){var A=B;if(B){var z=[];for(var y=0,E=B.length;y<E;y++){var D=B[y];var F={displayName:D.authority.displayName,fullName:D.authority.fullName,role:D.role};z.push(F)}z.sort(function(G,x){var I=G.displayName,H=x.displayName;return(I>H)?1:(I<H)?-1:0});A={items:z}}return A};if(v.options.currentUserRole!==undefined&&v.options.currentUserRole==="SiteManager"){this.isCurrentUserSiteAdmin=true}this._setupDataTable();this.widgets.searchButton=Alfresco.util.createYUIButton(this,"button",this.doSearch);this.widgets.addGroups=Alfresco.util.createYUIButton(this,"addGroups",null,{type:"link"});var s=b.get(this.id+"-term"),t=new YAHOO.util.KeyListener(s,{keys:13},{fn:function(){v.doSearch()},scope:this,correctScope:true},"keydown");t.enable();if(this.options.error){t.disable();this.widgets.dataTable.set("MSG_ERROR",this.options.error);this.widgets.dataTable.showTableMessage(this.options.error,YAHOO.widget.DataTable.CLASS_ERROR);YAHOO.Bubbling.fire("deactivateAllControls")}if(this.options.setFocus){s.focus()}if(window.location.hash==="#showall"||this.options.minSearchTermLength===0){this.doSearch()}b.setStyle(this.id+"-body","visibility","visible")},_setupDataTable:function a(){var z=this;var x=function t(E,D,F,G){b.setStyle(E.parentNode,"width",F.width+"px");E.innerHTML='<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/group-64.png" alt="group" />'};var s=function u(F,E,G,J){var D=E.getData("displayName"),I=E.getData("fullName");var H="<h3>"+k(D)+"</h3>";H+='<div><span class="attr-name">'+z._msg("label.name")+': </span>&nbsp;<span class="attr-value">'+k(I)+"</span></div>";F.innerHTML=H};var A=function v(K,N,H,E){b.setStyle(K.parentNode,"width",H.width+"px");b.setStyle(K.parentNode,"text-align","right");b.addClass(K,"overflow");var F=N.getData("role");if(z.isCurrentUserSiteAdmin){var M=N.getData("fullName");K.innerHTML='<span id="'+z.id+"-roleSelector-"+M+'"></span>';var I=[],G;for(var J=0,D=z.options.roles.length;J<D;J++){G=z.options.roles[J];I.push({text:z._msg("role."+G),value:G,onclick:{fn:z.onRoleSelect,obj:{group:M,currentRole:F,newRole:G,recordId:N.getId()},scope:z}})}var L=new YAHOO.widget.Button({container:z.id+"-roleSelector-"+M,type:"menu",label:z._msg("role."+F)+" "+Alfresco.constants.MENU_ARROW_SYMBOL,menu:I});z.listWidgets[M]={roleSelector:L};z.buttons[M+"-roleSelector"]={roleSelector:L}}else{K.innerHTML="<div>"+z._msg("role."+F)+"</div>"}};var y=function B(F,E,G,I){b.setStyle(F.parentNode,"width",G.width+"px");if(z.isCurrentUserSiteAdmin){var H=E.getData("fullName");F.innerHTML='<span id="'+z.id+"-button-"+H+'"></span>';var D=new YAHOO.widget.Button({container:z.id+"-button-"+H,label:z._msg("site-groups.remove"),onclick:{fn:z.doRemove,obj:E.getData(),scope:z}});z.buttons[H+"-button"]={button:D}}else{F.innerHTML="<div></div>"}};var w=[{key:"displayName",label:"Group Name",sortable:false,formatter:x,width:64},{key:"fullName",label:"Details",sortable:false,formatter:s},{key:"role",label:"Select Role",formatter:A,width:140},{key:"uninvite",label:"Uninvite",formatter:y,width:80}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-groups",w,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:'<span style="white-space: nowrap;">'+this._msg("site-groups.enter-search-term")+"</span>"});this.widgets.dataTable.doBeforeLoadData=function C(E,F,H){if(F.error){try{var D=YAHOO.lang.JSON.parse(F.responseText);z.widgets.dataTable.set("MSG_ERROR",D.message)}catch(G){z._setDefaultDataTableErrors(z.widgets.dataTable)}}else{if(F.results){if(F.results.length===0){z.widgets.dataTable.set("MSG_EMPTY",'<span style="white-space: nowrap;">'+z._msg("message.empty")+"</span>")}z.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}}return true}},doSearch:function c(){var s=YAHOO.lang.trim(b.get(this.id+"-term").value);if(s.length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this._msg("message.minimum-length",this.options.minSearchTermLength)});return}this._performSearch(s)},doRemove:function l(u,v){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this._msg("message.removing"),spanClass:"wait",displayTime:0});var w=function x(z,A){this.widgets.feedbackMessage.destroy();Alfresco.util.PopupManager.displayMessage({text:this._msg("site-groups.remove-success",A.displayName)});var y=this.widgets.dataTable.getRecordIndex(u.target.id);this.widgets.dataTable.deleteRow(y)};var s=function t(y){this.widgets.feedbackMessage.destroy()};Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/sites/"+this.options.siteId+"/memberships/"+encodeURIComponent(v.fullName),method:"DELETE",successCallback:{fn:w,obj:v,scope:this},failureMessage:this._msg("site-groups.remove-failure",v.displayName),failureCallback:{fn:s,scope:this}})},onRoleSelect:function p(z,s,y){var x=this.widgets.dataTable.getRecord(y.recordId),w=x.getData(),v=this.widgets.dataTable.getRecordIndex(x),u=w.role,B=y.newRole,C=y.group;if(B!==u){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this._msg("message.changingrole"),spanClass:"wait",displayTime:0});var D=function A(F,G){this.widgets.feedbackMessage.destroy();Alfresco.util.PopupManager.displayMessage({text:this._msg("site-groups.change-role-success",G.groupDisplayName,this._msg("role."+G.role))});var H=this.widgets.dataTable.getRecord(G.recordIndex).getData();H.role=y.newRole;this.widgets.dataTable.updateRow(G.recordIndex,H)};var t=function E(F){this.widgets.feedbackMessage.destroy()};Alfresco.util.Ajax.jsonPut({url:Alfresco.constants.PROXY_URI+"api/sites/"+this.options.siteId+"/memberships",dataObj:{role:B,group:{fullName:C}},successCallback:{fn:D,obj:{groupDisplayName:w.displayName,role:B,recordIndex:v},scope:this},failureMessage:this._msg("site-groups.change-role-failure",C),failureCallback:{fn:t,scope:this}})}},onDeactivateAllControls:function i(u,t){var s,v,w=Alfresco.util.disableYUIButton;for(s in this.widgets){if(this.widgets.hasOwnProperty(s)){w(this.widgets[s])}}},_setDefaultDataTableErrors:function e(s){var t=Alfresco.util.message;s.set("MSG_EMPTY",t("message.empty","Alfresco.SiteGroups"));s.set("MSG_ERROR",t("message.error","Alfresco.SiteGroups"))},_performSearch:function o(s){if(!this.isSearching){this.isSearching=true;this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.set("MSG_EMPTY",this._msg("site-groups.searching"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());function t(v,w,x){this._enableSearchUI();this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,v,w,x);this._setDefaultDataTableErrors(this.widgets.dataTable)}function u(w,x){this._enableSearchUI();if(x.status==401){window.location.reload()}else{try{var v=YAHOO.lang.JSON.parse(x.responseText);this.widgets.dataTable.set("MSG_ERROR",v.message);this.widgets.dataTable.showTableMessage(Alfresco.util.encodeHTML(v.message),YAHOO.widget.DataTable.CLASS_ERROR)}catch(y){this._setDefaultDataTableErrors(this.widgets.dataTable)}}}this.widgets.dataSource.sendRequest(this._buildSearchParams(s),{success:t,failure:u,scope:this});this.widgets.searchButton.set("disabled",true);YAHOO.lang.later(2000,this,function(){if(this.isSearching){if(!this.widgets.feedbackMessage){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.searching",this.name),spanClass:"wait",displayTime:0})}else{if(!this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.show()}}}},[])}},_enableSearchUI:function n(){if(this.widgets.feedbackMessage&&this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.hide()}this.widgets.searchButton.set("disabled",false);this.isSearching=false},_buildSearchParams:function h(s){var t=YAHOO.lang.substitute("size={maxResults}&nf={term}&authorityType=GROUP",{maxResults:this.options.maxSearchResults,term:encodeURIComponent(s)});return t},_msg:function f(s){return Alfresco.util.message.call(this,s,"Alfresco.SiteGroups",Array.prototype.slice.call(arguments).slice(1))}}})();