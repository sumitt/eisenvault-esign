(function(){var f=YAHOO.util.Dom,j=YAHOO.util.Event,a=YAHOO.util.Element;var e=Alfresco.util.encodeHTML;Alfresco.LinkEdit=function(m){return Alfresco.LinkEdit.superclass.constructor.call(this,"Alfresco.LinkEdit",m,["json","button","menu"])};YAHOO.extend(Alfresco.LinkEdit,Alfresco.component.Base,{options:{siteId:"",containerId:"links",editMode:false,linkId:""},linkData:null,onReady:function l(){if(this.options.editMode){this._loadLinkData()}else{this._initializeLinkForm()}},_loadLinkData:function k(){var o=this;var p=function n(q){var r=q.json.item;o.linkData=r;o._initializeLinkForm()};var m=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"/api/links/link/site/{site}/{container}/{linkId}",{site:this.options.siteId,container:this.options.containerId,linkId:this.options.linkId});Alfresco.util.Ajax.request({url:m,method:"GET",responseContentType:"application/json",successCallback:{fn:p,scope:this},failureMessage:this.msg("message.loadlinkdata.failure")})},_initializeLinkForm:function b(){var q="";if(this.options.editMode){q=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/links/site/{site}/{container}/{linkId}",{site:this.options.siteId,container:this.options.containerId,linkId:this.options.linkId})}else{q=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/links/site/{site}/{container}/posts",{site:this.options.siteId,container:this.options.containerId})}var p=f.get(this.id+"-form");p.setAttribute("action",q);var r="";if(this.options.editMode){r=this.linkData.title}f.get(this.id+"-title").setAttribute("value",r);var o="";if(this.options.editMode){o=this.linkData.description}f.get(this.id+"-description").value=o;var n="";if(this.options.editMode){n=e(this.linkData.url)}f.get(this.id+"-url").value=n;var m=false;if(this.options.editMode){m=this.linkData.internal}f.get(this.id+"-internal").checked=m;f.get(this.id+"-tag-input-field").tabIndex=5;f.get(this.id+"-add-tag-button").tabIndex=6;this._registerLinkForm()},_registerLinkForm:function i(){this.modules.tagLibrary=new Alfresco.module.TagLibrary(this.id);this.modules.tagLibrary.setOptions({siteId:this.options.siteId});if(this.options.editMode&&this.linkData.tags.length>0){this.modules.tagLibrary.setTags(this.linkData.tags)}var n="";if(this.options.editMode){n=this.msg("button.update")}else{n=this.msg("button.save")}this.widgets.okButton=new YAHOO.widget.Button(this.id+"-ok",{type:"submit",label:n});f.addClass(this.widgets.okButton._button.parentElement.parentElement,"alf-primary-button");this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onFormCancelButtonClick);this.widgets.linkForm=new Alfresco.forms.Form(this.id+"-form");this.widgets.linkForm.addValidation(this.id+"-title",Alfresco.forms.validation.mandatory,null,"keyup");this.widgets.linkForm.addValidation(this.id+"-title",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");this.widgets.linkForm.addValidation(this.id+"-description",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");this.widgets.linkForm.addValidation(this.id+"-url",Alfresco.forms.validation.mandatory,null,"blur");this.widgets.linkForm.addValidation(this.id+"-url",Alfresco.forms.validation.regexMatch,{pattern:/^(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/},"keyup");this.widgets.linkForm.addValidation(this.id+"-url",Alfresco.forms.validation.length,{max:2048,crop:true},"blur");this.widgets.linkForm.setSubmitElements(this.widgets.okButton);this.widgets.linkForm.setAJAXSubmit(true,{successCallback:{fn:this.onFormSubmitSuccess,scope:this},failureMessage:this.msg("message.savelink.failure"),failureCallback:{fn:this.onFormSubmitFailure,scope:this}});if(this.options.editMode){this.widgets.linkForm.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT)}this.widgets.linkForm.setSubmitAsJSON(true);this.widgets.linkForm.doBeforeFormSubmit={fn:function(o,p){this.widgets.cancelButton.set("disabled",true);this.modules.tagLibrary.updateForm(this.id+"-form","tags");this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(this.msg("message.submitting")),spanClass:"wait",displayTime:0})},scope:this};this.modules.tagLibrary.initialize(this.widgets.linkForm);this.widgets.linkForm.init();var m=YAHOO.util.Dom.get(this.id+"-div");f.removeClass(m,"hidden");f.get(this.id+"-title").focus()},onFormCancelButtonClick:function h(n,m){history.go(-1)},onFormSubmitSuccess:function c(m){this.widgets.feedbackMessage.destroy();var n=this.options.linkId;if(!this.options.editMode){n=m.json.name}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.savelink.success")});this._loadLinkViewPage(n)},onFormSubmitFailure:function g(m){m.config.failureMessage=this.msg("message.savelink.failure");this.widgets.cancelButton.set("disabled",false);this.widgets.feedbackMessage.destroy()},_loadLinkViewPage:function d(n){var m=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links-view?linkId={linkId}",{site:this.options.siteId,linkId:n});window.location=m}})})();