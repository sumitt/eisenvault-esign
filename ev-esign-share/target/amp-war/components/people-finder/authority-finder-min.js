(function(){var d=YAHOO.util.Dom,l=YAHOO.util.Event;var c=Alfresco.util.encodeHTML,h=Alfresco.util.userProfileLink;Alfresco.AuthorityFinder=function(o){Alfresco.AuthorityFinder.superclass.constructor.call(this,"Alfresco.AuthorityFinder",o,["button","container","datasource","datatable","json"]);this.itemSelectButtons={};this.searchTerm="";this.singleSelectedItem="";this.selectedItems={};this.notAllowed={};YAHOO.Bubbling.on("itemSelected",this.onItemSelected,this);YAHOO.Bubbling.on("itemDeselected",this.onItemDeselected,this);return this};YAHOO.lang.augmentObject(Alfresco.AuthorityFinder,{VIEW_MODE_DEFAULT:"",VIEW_MODE_COMPACT:"COMPACT",VIEW_MODE_FULLPAGE:"FULLPAGE"});YAHOO.lang.augmentObject(Alfresco.AuthorityFinder,{AUTHORITY_TYPE_ALL:"all",AUTHORITY_TYPE_USERS:"user",AUTHORITY_TYPE_GROUPS:"group"});YAHOO.lang.extend(Alfresco.AuthorityFinder,Alfresco.component.Base,{options:{siteId:"",viewMode:Alfresco.AuthorityFinder.VIEW_MODE_DEFAULT,authorityType:Alfresco.AuthorityFinder.AUTHORITY_TYPE_ALL,singleSelectMode:false,minSearchTermLength:3,maxSearchResults:100,wildcardPrefix:false,setFocus:false,addButtonSuffix:"",dataWebScript:Alfresco.constants.URL_SERVICECONTEXT+"components/people-finder/authority-query"},itemSelectButtons:null,searchTerm:null,singleSelectedItem:null,selectedItems:null,notAllowed:null,onReady:function g(){var p=this;if(this.options.viewMode==Alfresco.AuthorityFinder.VIEW_MODE_COMPACT){d.addClass(this.id+"-body","compact")}else{if(this.options.viewMode==Alfresco.AuthorityFinder.VIEW_MODE_FULLPAGE){d.setStyle(this.id+"-results","height","auto")}else{d.setStyle(this.id+"-results","height","300px")}}this.widgets.searchButton=Alfresco.util.createYUIButton(this,"authority-search-button",this.onSearchClick);var s=YAHOO.lang.substitute(this.options.dataWebScript,this.options);s+=(s.indexOf("?")<0)?"?":"&";s+="authorityType="+this.options.authorityType+"&";s+="maxResults="+this.options.maxSearchResults+"&";if(this.options.siteScope){s+="site="+this.options.siteScope+"&"}this.widgets.dataSource=new YAHOO.util.DataSource(s,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"authorities"}});this.widgets.dataSource.doBeforeParseData=function r(w,v){var u=v;if(v&&v.authorities){var t=v.authorities;if(t.length>p.options.maxSearchResults){t=t.slice(0,p.options.maxSearchResults-1)}p.notAllowed={};if(v.notAllowed){p.notAllowed=Alfresco.util.arrayToObject(v.notAllowed)}u={authorities:t}}return u};this._setupDataTable();d.get(this.id+"-title").innerHTML=this.msg("title."+this.options.authorityType);var q=d.get(this.id+"-search-text");var o=new YAHOO.util.KeyListener(q,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function(t,u,v){p.onSearchClick();l.stopEvent(u[1]);return false},scope:this,correctScope:true},YAHOO.env.ua.ie>0?YAHOO.util.KeyListener.KEYDOWN:"keypress");o.enable();if(this.options.setFocus){q.focus()}},_setupDataTable:function b(){var y=this;var w=function x(E,D,F,G){d.setStyle(E.parentNode,"width",F.width+"px");var B=D.getData("authorityType"),C=D.getData("metadata")||{},A=Alfresco.constants.URL_RESCONTEXT+"components/images/"+(B=="USER"?"no-user-photo-64.png":"group-64.png");if(C.avatar&&C.avatar.length!==0){A=Alfresco.constants.PROXY_URI+C.avatar+"?c=queue&ph=true"}D.setData("calc_iconUrl",A);E.innerHTML='<img class="avatar" src="'+A+'" alt="avatar" />'};var p=function t(H,J,D,B){var E=J.getData("authorityType"),F=J.getData("metadata"),C="";if(E=="USER"){var G=J.getData("shortName"),I=F.jobTitle||"",A=F.organization||"";C='<h3 class="itemname">'+h(G,J.getData("displayName"),'class="theme-color-1"')+' <span class="lighter">('+c(G)+")</span></h3>";if(I.length>0){C+='<div class="detail">'+c(I)+"</div>"}if(A.length>0){C+='<div class="detail">&nbsp;('+c(A)+")</div>"}}else{if(E=="GROUP"){C='<h3 class="itemname">'+c(J.getData("displayName"))+' <span class="lighter">('+c(J.getData("fullName"))+")</span></h3>"}}H.innerHTML=C};var o=function u(H,J,D,B){var E=J.getData("authorityType"),F=J.getData("metadata"),C="";if(E=="USER"){var G=J.getData("shortName"),I=F.jobTitle||"",A=F.organization||"";C='<h3 class="itemname">'+h(G,J.getData("displayName"),'class="theme-color-1"')+' <span class="lighter">('+c(G)+")</span></h3>";if(I.length>0){C+='<div class="detail"><span>'+y.msg("label.title")+":</span> "+c(I)+"</div>"}if(A.length>0){C+='<div class="detail"><span>'+y.msg("label.company")+":</span> "+c(A)+"</div>"}}else{if(E=="GROUP"){C='<h3 class="itemname">'+c(J.getData("displayName"))+"</h3>";C+='<div class="detail"><span>'+y.msg("label.name")+":</span> "+c(J.getData("fullName"))+"</div>"}}H.innerHTML=C};var s=function r(D,B,F,H){d.setStyle(D.parentNode,"width",F.width+"px");d.setStyle(D.parentNode,"text-align","right");var E=Alfresco.util.generateDomId(),G='<span id="'+E+'"></span>',C=B.getData("fullName");D.innerHTML=G;if(y.options.viewMode!==Alfresco.AuthorityFinder.VIEW_MODE_FULLPAGE){var A=new YAHOO.widget.Button({type:"button",label:y.msg("button.add")+" "+y.options.addButtonSuffix,name:E+"-name",container:E,disabled:C in y.notAllowed,onclick:{fn:y.onItemSelect,obj:B,scope:y}});y.itemSelectButtons[C]=A;if((C in y.selectedItems)||(y.options.singleSelectMode&&y.singleSelectedItem!=="")){y.itemSelectButtons[C].set("disabled",true)}}};var q=this.options.viewMode==Alfresco.AuthorityFinder.VIEW_MODE_COMPACT,v=[{key:"authorityType",label:"Icon",sortable:false,formatter:w,width:(q?36:70)},{key:"fullName",label:"Description",sortable:false,formatter:(q?p:o)},{key:"actions",label:"Actions",sortable:false,formatter:s,width:80}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",v,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:this.msg("message.instructions")});this.widgets.dataTable.doBeforeLoadData=function z(A,B,C){if(B.results){this.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}return true};this.widgets.dataTable.subscribe("rowMouseoverEvent",this.widgets.dataTable.onEventHighlightRow);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.widgets.dataTable.onEventUnhighlightRow)},clearResults:function n(){if(this.widgets.dataTable){var o=this.widgets.dataTable.getRecordSet().getLength();this.widgets.dataTable.deleteRows(0,o)}d.get(this.id+"-search-text").value="";this.singleSelectedItem="";this.selectedItems={}},onItemSelect:function a(o,p){YAHOO.Bubbling.fire("itemSelected",{itemName:p.getData("fullName"),shortName:p.getData("shortName"),displayName:p.getData("displayName"),iconUrl:p.getData("calc_iconUrl"),eventGroup:this})},onSearchClick:function k(q,r){var p=d.get(this.id+"-search-text");var o=YAHOO.lang.trim(p.value);if(o.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});return}this.itemSelectButtons={};this._performSearch(o)},onItemSelected:function m(q,o){var s=o[1];if(s&&(s.itemName!==null)){var r=s.itemName;this.selectedItems[r]=true;this.singleSelectedItem=r;if(this.options.singleSelectMode){for(var p in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(p)){this.itemSelectButtons[p].set("disabled",true)}}}else{this.itemSelectButtons[r].set("disabled",true)}}},onItemDeselected:function f(q,o){var r=o[1];if(r&&(r.itemName!==null)){delete this.selectedItems[r.itemName];this.singleSelectedItem="";if(this.options.singleSelectMode){for(var p in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(p)){this.itemSelectButtons[p].set("disabled",false)}}}else{this.itemSelectButtons[r.itemName].set("disabled",false)}}},_setDefaultDataTableErrors:function i(o){var p=Alfresco.util.message;o.set("MSG_EMPTY",p("message.empty","Alfresco.AuthorityFinder"));o.set("MSG_ERROR",p("message.error","Alfresco.AuthorityFinder"))},_performSearch:function e(o){this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.set("MSG_EMPTY",this.msg("message.searching"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.widgets.dataTable.render();var q=function p(t,u,v){this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,t,u,v)};var s=function r(u,v){if(v.status==401){window.location.reload()}else{try{var t=YAHOO.lang.JSON.parse(v.responseText);this.widgets.dataTable.set("MSG_ERROR",t.message);this.widgets.dataTable.showTableMessage(Alfresco.util.encodeHTML(t.message),YAHOO.widget.DataTable.CLASS_ERROR)}catch(w){this._setDefaultDataTableErrors(this.widgets.dataTable)}}};this.searchTerm=o;this.widgets.dataSource.sendRequest(this._buildSearchParams(o),{success:q,failure:s,scope:this})},_buildSearchParams:function j(o){return"filter="+(this.options.wildcardPrefix?"*":"")+encodeURIComponent(o)+(this.options.siteId?"&defGroupsFor="+encodeURIComponent(this.options.siteId):"")}})})();