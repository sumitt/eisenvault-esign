(function(){var g=YAHOO.util.Dom,n=YAHOO.util.Event;var d=Alfresco.util.encodeHTML;Alfresco.GroupFinder=function(p){Alfresco.GroupFinder.superclass.constructor.call(this,"Alfresco.GroupFinder",p,["button","container","datasource","datatable","json"]);this.itemSelectButtons={};this.searchTerm="";this.singleSelectedItem="";this.selectedItems={};this.notAllowed={};this.eventGroup=p;YAHOO.Bubbling.on("itemSelected",this.onItemSelected,this);YAHOO.Bubbling.on("itemDeselected",this.onItemDeselected,this);YAHOO.Bubbling.on("allItemsDeselected",this.onAllItemsDeselected,this);return this};YAHOO.lang.augmentObject(Alfresco.GroupFinder,{VIEW_MODE_DEFAULT:"",VIEW_MODE_COMPACT:"COMPACT",VIEW_MODE_FULLPAGE:"FULLPAGE"});YAHOO.lang.extend(Alfresco.GroupFinder,Alfresco.component.Base,{options:{siteId:"",viewMode:Alfresco.GroupFinder.VIEW_MODE_DEFAULT,singleSelectMode:false,minSearchTermLength:1,maxSearchResults:100,wildcardPrefix:false,setFocus:false,addButtonSuffix:"",dataWebScript:""},itemSelectButtons:null,searchTerm:null,singleSelectedItem:null,selectedItems:null,notAllowed:null,isSearching:false,onReady:function h(){var r=this;if(this.options.viewMode==Alfresco.GroupFinder.VIEW_MODE_COMPACT){g.addClass(this.id+"-body","compact")}else{if(this.options.viewMode==Alfresco.GroupFinder.VIEW_MODE_FULLPAGE){g.setStyle(this.id+"-results","height","auto")}else{g.setStyle(this.id+"-results","height","300px")}}this.widgets.searchButton=Alfresco.util.createYUIButton(this,"group-search-button",this.onSearchClick);var q=Alfresco.constants.PROXY_URI+YAHOO.lang.substitute(this.options.dataWebScript,this.options);q+=(q.indexOf("?")<0)?"?":"&";q+="zone=APP.DEFAULT&";this.widgets.dataSource=new YAHOO.util.DataSource(q,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"data"}});this.widgets.dataSource.doBeforeParseData=function t(x,w){var v=w;if(w&&w.data){var u=w.data;if(u.length>r.options.maxSearchResults){u=u.slice(0,r.options.maxSearchResults-1)}r.notAllowed={};if(w.notAllowed){r.notAllowed=Alfresco.util.arrayToObject(w.notAllowed)}v={data:u}}return v};this._setupDataTable();var s=g.get(this.id+"-search-text");var p=new YAHOO.util.KeyListener(s,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function(u,v,w){r.onSearchClick();n.stopEvent(v[1]);return false},scope:this,correctScope:true},YAHOO.env.ua.ie>0?YAHOO.util.KeyListener.KEYDOWN:"keypress");p.enable();if(this.options.setFocus){s.focus()}},_setupDataTable:function e(){var w=this;var u=function q(z,y,A,B){g.setStyle(z.parentNode,"width",A.width+"px");z.innerHTML='<img class="avatar" src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/group-64.png" alt="avatar" />'};var p=function r(z,y,A,C){var B='<h3 class="itemname">'+d(y.getData("displayName"))+"</h3>";if(w.options.viewMode!==Alfresco.GroupFinder.VIEW_MODE_COMPACT){B+='<div class="detail"><span>'+w.msg("label.name")+":</span> "+d(y.getData("fullName"))+"</div>"}z.innerHTML=B};var t=function x(B,z,D,F){g.setStyle(B.parentNode,"width",D.width+"px");g.setStyle(B.parentNode,"text-align","right");var C=Alfresco.util.generateDomId(),E='<span id="'+C+'"></span>',A=z.getData("fullName");B.innerHTML=E;if(w.options.viewMode!==Alfresco.GroupFinder.VIEW_MODE_FULLPAGE){var y=new YAHOO.widget.Button({type:"button",label:w.msg("button.add")+" "+w.options.addButtonSuffix,name:C+"-name",container:C,disabled:A in w.notAllowed,onclick:{fn:w.onItemSelect,obj:z,scope:w}});w.itemSelectButtons[A]=y;if((A in w.selectedItems)||(w.options.singleSelectMode&&w.singleSelectedItem!=="")){w.itemSelectButtons[A].set("disabled",true)}}};var v=[{key:"icon",label:"Icon",sortable:false,formatter:u,width:this.options.viewMode==Alfresco.GroupFinder.VIEW_MODE_COMPACT?36:70},{key:"description",label:"Description",sortable:false,formatter:p},{key:"actions",label:"Actions",sortable:false,formatter:t,width:80}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",v,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:this.msg("message.instructions")});this.widgets.dataTable.doBeforeLoadData=function s(y,z,A){if(z.results){this.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}return true};this.widgets.dataTable.subscribe("rowMouseoverEvent",this.widgets.dataTable.onEventHighlightRow);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.widgets.dataTable.onEventUnhighlightRow)},clearResults:function a(){if(this.widgets.dataTable){var p=this.widgets.dataTable.getRecordSet().getLength();this.widgets.dataTable.deleteRows(0,p)}g.get(this.id+"-search-text").value="";this.singleSelectedItem="";this.selectedItems={}},onItemSelect:function c(p,q){YAHOO.Bubbling.fire("itemSelected",{eventGroup:this,itemName:q.getData("fullName"),displayName:q.getData("displayName")})},onSearchClick:function j(q,r){var p=YAHOO.lang.trim(g.get(this.id+"-search-text").value);if(p.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});return}this.itemSelectButtons={};this._performSearch(p)},onItemSelected:function i(r,p){var t=p[1];if(t&&(t.itemName!==null)&&(!t.eventGroup||(t.eventGroup&&Alfresco.util.hasEventInterest(this,p)))){var s=t.itemName;this.selectedItems[s]=true;this.singleSelectedItem=s;if(this.options.singleSelectMode){for(var q in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(q)){this.itemSelectButtons[q].set("disabled",true)}}}else{if(this.itemSelectButtons[s]){this.itemSelectButtons[s].set("disabled",true)}}}},onItemDeselected:function o(r,p){var s=p[1];if(s&&(s.itemName!==null)&&(!s.eventGroup||(s.eventGroup&&Alfresco.util.hasEventInterest(this,p)))){delete this.selectedItems[s.itemName];this.singleSelectedItem="";if(this.options.singleSelectMode){for(var q in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(q)){this.itemSelectButtons[q].set("disabled",false)}}}else{if(this.itemSelectButtons[s.itemName]){this.itemSelectButtons[s.itemName].set("disabled",false)}}}},onAllItemsDeselected:function l(r,p){var s=p[1];if(s&&(!s.eventGroup||(s.eventGroup&&Alfresco.util.hasEventInterest(this,p)))){this.selectedItems={};this.singleSelectedItem="";for(var q in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(q)){this.itemSelectButtons[q].set("disabled",false)}}}},_setDefaultDataTableErrors:function k(p){var q=Alfresco.util.message;p.set("MSG_EMPTY",q("message.empty","Alfresco.GroupFinder"));p.set("MSG_ERROR",q("message.error","Alfresco.GroupFinder"))},_performSearch:function b(p){if(!this.isSearching){this.isSearching=true;this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.set("MSG_EMPTY",this.msg("message.searching"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.widgets.dataTable.render();var q=function s(u,v,w){this._enableSearchUI();this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,u,v,w)};var r=function t(v,w){this._enableSearchUI();if(w.status==401){window.location.reload()}else{try{var u=YAHOO.lang.JSON.parse(w.responseText);this.widgets.dataTable.set("MSG_ERROR",u.message);this.widgets.dataTable.showTableMessage(Alfresco.util.encodeHTML(u.message),YAHOO.widget.DataTable.CLASS_ERROR)}catch(x){this._setDefaultDataTableErrors(this.widgets.dataTable)}}};this.searchTerm=p;this.widgets.dataSource.sendRequest(this._buildSearchParams(p),{success:q,failure:r,scope:this});this.widgets.searchButton.set("disabled",true);YAHOO.lang.later(2000,this,function(){if(this.isSearching){if(!this.widgets.feedbackMessage){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.searching",this.name),spanClass:"wait",displayTime:0})}else{if(!this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.show()}}}},[])}},_enableSearchUI:function m(){if(this.widgets.feedbackMessage&&this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.hide()}this.widgets.searchButton.set("disabled",false);this.isSearching=false},_buildSearchParams:function f(p){return"shortNameFilter="+(this.options.wildcardPrefix?"*":"")+encodeURIComponent(p)+"&maxResults="+this.options.maxSearchResults}})})();