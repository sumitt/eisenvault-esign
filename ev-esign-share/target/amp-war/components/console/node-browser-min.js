(function(){var f=YAHOO.util.Dom,m=YAHOO.util.Event,b=YAHOO.util.Element;var e=Alfresco.util.encodeHTML;Alfresco.ConsoleNodeBrowser=function(F){this.name="Alfresco.ConsoleNodeBrowser";Alfresco.ConsoleNodeBrowser.superclass.constructor.call(this,F);Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","datasource","datatable","json","history"],this.onComponentsLoaded,this);YAHOO.Bubbling.on("viewNodeClick",this.onViewNodeClick,this);var t=this;SearchPanelHandler=function s(){SearchPanelHandler.superclass.constructor.call(this,"search")};YAHOO.extend(SearchPanelHandler,Alfresco.ConsolePanelHandler,{isSearching:false,onLoad:function B(){var K=function(L){var M=L.newValue;this.set("label",(M.cfg.getProperty("text")));this.set("value",(M.cfg.getProperty("text")));return};var G=function(N,M){var L=M[0],O=M[1];if(O){this.set("label",(O.cfg.getProperty("text")));this.set("value",(O.cfg.getProperty("text")))}};var J=function(N,L,M){M.set("selectedMenuItem",this.getItem(0))};t.widgets.searchButton=Alfresco.util.createYUIButton(t,"search-button",t.onSearchClick);Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"slingshot/node/stores",successCallback:{fn:function(M){var L=M.json.stores;t.widgets.storeMenuButton=new YAHOO.widget.Button(t.id+"-store-menu-button",{type:"menu",menu:L,lazyloadmenu:false});t.widgets.storeMenuButton.set("value",t.store);t.widgets.storeMenuButton.set("label",t.store);t.widgets.storeMenuButton.on("selectedMenuItemChange",K)},scope:this},failureMessage:t._msg("message.getstores-failure")});t.widgets.langMenuButton=new YAHOO.widget.Button(t.id+"-lang-menu-button",{type:"menu",menu:t.id+"-lang-menu-select"});t.widgets.langMenuButton.on("selectedMenuItemChange",function(){K.apply(this,arguments);f.get(t.id+"-search-text").disabled=(t.widgets.langMenuButton.get("value")=="storeroot")});t.widgets.langMenuButton.set("value",t.searchLanguage);t.widgets.langMenuButton.set("label",t.searchLanguage);t.widgets.dataSource=new YAHOO.util.DataSource(Alfresco.constants.PROXY_URI+"slingshot/node/search",{responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"results",metaFields:{recordOffset:"startIndex",totalRecords:"totalResults",searchElapsedTime:"searchElapsedTime"}}});var H=this;t.widgets.dataSource.doBeforeParseData=function I(P,N){var M=N;if(N&&N.results){var L=N.results,Q=parseInt(N.searchElapsedTime,10);L.sort(function(S,R){return(S.name>R.name)});M={results:L}}var O="";if(Q<1000){O=""+Q+t.msg("label.elapsedMilliseconds")}else{if(Q>=1000&&Q<10000){O=""+(Math.round(Q/100)/10)+t.msg("label.elapsedSeconds")}else{O=""+Math.round(Q/1000)+t.msg("label.elapsedSeconds")}}if(L&&L.length<t.options.maxSearchResults){H._setResultsMessage("message.results",e(t.searchTerm),L.length,O)}else{H._setResultsMessage("message.maxresults",e(t.searchTerm),t.options.maxSearchResults,O)}return M};this._setupDataTable()},onShow:function r(){if(!f.get(t.id+"-search-text").disabled){f.get(t.id+"-search-text").focus();f.get(t.id+"-search-text").select()}},onUpdate:function x(){var G=f.get(t.id+"-search-text");G.value=t.searchTerm;t.widgets.langMenuButton.set("value",t.searchLanguage);t.widgets.langMenuButton.set("label",t.searchLanguage);f.get(t.id+"-search-text").disabled=(t.widgets.langMenuButton.get("value")=="storeroot");if(t.widgets.storeMenuButton){t.widgets.storeMenuButton.set("value",t.store);t.widgets.storeMenuButton.set("label",t.store)}if(!this.isSearching&&t.searchTerm!==undefined&&t.searchTerm.length>=t.options.minSearchTermLength){this.isSearching=true;var L=this;L._setDefaultDataTableErrors(t.widgets.dataTable);t.widgets.dataTable.set("MSG_EMPTY",t._msg("message.searching"));t.widgets.dataTable.deleteRows(0,t.widgets.dataTable.getRecordSet().getLength());var H=function K(M,N,O){L._enableSearchUI();L._setDefaultDataTableErrors(t.widgets.dataTable);t.widgets.dataTable.onDataReturnInitializeTable.call(t.widgets.dataTable,M,N,O)};var J=function I(N,O){L._enableSearchUI();if(O.status==401){window.location.reload()}else{try{var M=YAHOO.lang.JSON.parse(O.responseText);t.widgets.dataTable.set("MSG_ERROR",M.message);t.widgets.dataTable.showTableMessage(Alfresco.util.encodeHTML(M.message),YAHOO.widget.DataTable.CLASS_ERROR);L._setResultsMessage("message.noresults")}catch(P){L._setDefaultDataTableErrors(t.widgets.dataTable)}}};t.widgets.dataSource.sendRequest(L._buildSearchParams(t.searchTerm,t.searchLanguage,t.store),{success:H,failure:J,scope:t});L._setResultsMessage("message.searchingFor",e(t.searchTerm));t.widgets.searchButton.set("disabled",true);YAHOO.lang.later(2000,L,function(){if(L.isSearching){if(!L.widgets.feedbackMessage){L.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.searching",t.name),spanClass:"wait",displayTime:0})}else{if(!L.widgets.feedbackMessage.cfg.getProperty("visible")){L.widgets.feedbackMessage.show()}}}},[])}},_enableSearchUI:function w(){if(this.widgets.feedbackMessage&&this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.hide()}t.widgets.searchButton.set("disabled",false);this.isSearching=false},_setupDataTable:function C(){var L=function L(N,M,O,P){N.innerHTML=e(P)};var J=function J(N,M,O,P){N.innerHTML=e(P[t._qnamePropertyName()])};var H=function H(O,N,Q,R){if(R!=""){var P=R[t._qnamePropertyName()];var M=t.options.shortQNames?P.lastIndexOf("/"):P.lastIndexOf("/{");P=M!=-1?P.substring(0,M):P;O.innerHTML=e(P)}};var I=function I(N,M,O,P){if(P!=""){G(N,M,O,e(P[t._qnamePropertyName()]))}};var G=function G(O,N,P,Q){var M=document.createElement("a");f.setAttribute(M,"href","#");M.innerHTML=e(Q);YAHOO.util.Event.addListener(M,"click",function(R){YAHOO.util.Event.preventDefault(R);YAHOO.Bubbling.fire("viewNodeClick",{nodeRef:N.getData("nodeRef")})},null,t);O.appendChild(M)};var K=[{key:"name",label:t._msg("label.name"),sortable:true,formatter:I},{key:"qnamePath",label:t._msg("label.parent_path"),sortable:true,formatter:H},{key:"nodeRef",label:t._msg("label.node-ref"),sortable:true,formatter:G}];t.widgets.dataTable=new YAHOO.widget.DataTable(t.id+"-datatable",K,t.widgets.dataSource,{initialLoad:false,renderLoopSize:32,sortedBy:{key:"name",dir:"asc"},MSG_EMPTY:t._msg("message.empty")})},_setDefaultDataTableErrors:function p(G){G.set("MSG_EMPTY",t._msg("message.datatable.empty"));G.set("MSG_ERROR",t._msg("message.datatable.error"))},_buildSearchParams:function z(H,I,G){return"?q="+encodeURIComponent(H)+"&lang="+encodeURIComponent(I)+"&store="+encodeURIComponent(G)+"&maxResults="+t.options.maxSearchResults},_setResultsMessage:function A(H){var G=f.get(t.id+"-search-bar");G.innerHTML=t._msg.apply(this,arguments)},onSuccess:function E(G){if(G&&G.json){if(G.json.success){window.location.reload(true)}else{if(G.json.message){Alfresco.util.PopupManager.displayPrompt({text:G.json.message})}}}else{Alfresco.util.PopupManager.displayPrompt({text:Alfresco.util.message("message.failure")})}}});new SearchPanelHandler();ViewPanelHandler=function q(){ViewPanelHandler.superclass.constructor.call(this,"view")};YAHOO.extend(ViewPanelHandler,Alfresco.ConsolePanelHandler,{onLoad:function D(){Alfresco.util.createYUIButton(t,"goback-button",t.onGoBackClick);Alfresco.util.createYUIButton(t,"goback-button-top",t.onGoBackClick)},onBeforeShow:function u(){f.get(t.id+"-view-title").innerHTML="";f.setStyle(t.id+"-view-main","visibility","hidden")},onShow:function v(){window.scrollTo(0,0)},onUpdate:function y(){window.scrollTo(0,0);Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"slingshot/node/"+t.currentNodeRef.replace("://","/"),method:Alfresco.util.Ajax.GET,successCallback:{fn:this.onDataLoad,scope:t},failureMessage:t._msg("message.getnode-failure",e(t.currentUserId))})},onDataLoad:function o(R){var aa=this,Q=R.json,J=Q.nodeRef;var N=function(ac,ab){f.get(t.id+ac).innerHTML=ab?e(ab):""};var X=function X(ae,ad,af,ag,ab){ab=ab||{};var ac=document.createElement("a");YAHOO.util.Dom.setAttribute(ac,"href","#");ac.innerHTML=e(ag);YAHOO.util.Event.addListener(ac,"click",function(ah){YAHOO.util.Event.preventDefault(ah);YAHOO.Bubbling.fire("viewNodeClick",{nodeRef:ab.nodeRef||ad.getData("nodeRef")})},null,t);ae.appendChild(ac)};var P=function P(ac,ab,ad,ae){ac.innerHTML=e(ae[t._qnamePropertyName()])};var H=function H(ac,ab,ad,ae){X(ac,ab,ad,ae[t._qnamePropertyName()])};var S=function H(ac,ab,ad,ae){X(ac,ab,ad,ae,{nodeRef:ae})};var O=function O(ae,ad,ag,ah){var af=function(al,ak){if(al.isNullValue){f.addClass(ak,"node-value-label");ak.innerHTML=t.msg("label.node-value-null")}else{if(al.dataType=="{http://www.alfresco.org/model/dictionary/1.0}content"){var aj="<a ";aj+='href="'+Alfresco.constants.PROXY_URI+"api/node/"+J.replace("://","/")+'/content">';aj+=e(al.value);aj+="</a>";var ai=document.createElement("a");ai.innerHTML=e(al.value);YAHOO.util.Dom.setAttribute(ai,"href",Alfresco.constants.PROXY_URI+"api/node/"+J.replace("://","/")+"/content;"+ad.getData("name").prefixedName);ak.appendChild(ai)}else{if(al.dataType=="{http://www.alfresco.org/model/dictionary/1.0}noderef"){X(ak,ad,ag,al.value,{nodeRef:al.value})}else{ak.innerHTML=e(al.value)}}}};if(ad.getData("multiple")==false){af(ah[0],ae.appendChild(document.createElement("div"),ae))}else{var ab=ae.appendChild(document.createElement("div"),ae);f.addClass(ab,"node-value-label");ab.innerHTML=t.msg("label.node-value-collection");for(var ac=0;ac<ah.length;ac++){af(ah[ac],ae.appendChild(document.createElement("div"),ae))}}};f.get(t.id+"-view-title").innerHTML=Q.name[t._qnamePropertyName()];N("-view-node-ref",Q.nodeRef);N("-view-node-path",Q.qnamePath[t._qnamePropertyName()]);N("-view-node-type",Q.type[t._qnamePropertyName()]);f.get(t.id+"-view-node-parent").innerHTML="";if(Q.parent!==null){var L=document.createElement("a");f.setAttribute(L,"href","#");L.innerHTML=e(Q.parentNodeRef);YAHOO.util.Event.addListener(L,"click",function(ab){YAHOO.util.Event.preventDefault(ab);YAHOO.Bubbling.fire("viewNodeClick",{nodeRef:Q.parentNodeRef})},null,t);f.get(t.id+"-view-node-parent").appendChild(L)}var U={MSG_EMPTY:t._msg("message.datatable.empty"),MSG_ERROR:t._msg("message.datatable.error")};var Z=new YAHOO.widget.DataTable(t.id+"-view-node-properties",[{key:"name",label:t.msg("label.properties-name"),formatter:P},{key:"type",label:t.msg("label.properties-type"),formatter:P},{key:"values",label:t.msg("label.properties-value"),formatter:O},{key:"residual",label:t.msg("label.properties-residual")}],new YAHOO.util.LocalDataSource(Q.properties),U);var W="";for(var T=0;T<Q.aspects.length;T++){W+=(T!=0?"<br />":"")+e(Q.aspects[T][t._qnamePropertyName()])}f.get(t.id+"-view-node-aspects").innerHTML=W;var V=new YAHOO.widget.DataTable(t.id+"-view-node-children",[{key:"name",label:t.msg("label.children-name"),formatter:H},{key:"type",label:t.msg("label.children-type"),formatter:P},{key:"nodeRef",label:t.msg("label.children-node-ref"),formatter:X},{key:"primary",label:t.msg("label.children-primary")},{key:"assocType",label:t.msg("label.children-assoc-type"),formatter:P},{key:"index",label:t.msg("label.children-index")}],new YAHOO.util.LocalDataSource(Q.children),U);var M=new YAHOO.widget.DataTable(t.id+"-view-node-parents",[{key:"name",label:t.msg("label.parents-name"),formatter:H},{key:"type",label:t.msg("label.parents-type"),formatter:P},{key:"nodeRef",label:t.msg("label.parents-node-ref"),formatter:X},{key:"primary",label:t.msg("label.parents-primary")},{key:"assocType",label:t.msg("label.parents-assoc-type"),formatter:P}],new YAHOO.util.LocalDataSource(Q.parents),U);var Y=new YAHOO.widget.DataTable(t.id+"-view-node-assocs",[{key:"assocType",label:t.msg("label.assocs-assoc-type"),formatter:P},{key:"targetRef",label:t.msg("label.assocs-node-ref"),formatter:S},{key:"type",label:t.msg("label.assocs-type"),formatter:P}],new YAHOO.util.LocalDataSource(Q.assocs),U);var I=new YAHOO.widget.DataTable(t.id+"-view-node-source-assocs",[{key:"assocType",label:t.msg("label.source-assocs-assoc-type"),formatter:P},{key:"sourceRef",label:t.msg("label.source-assocs-node-ref"),formatter:S},{key:"type",label:t.msg("label.source-assocs-type"),formatter:P}],new YAHOO.util.LocalDataSource(Q.sourceAssocs),U);var K=new YAHOO.widget.DataTable(t.id+"-view-node-permissions",[{key:"permission",label:t.msg("label.permissions-permission")},{key:"authority",label:t.msg("label.permissions-authority")},{key:"rel",label:t.msg("label.permissions-access")}],new YAHOO.util.LocalDataSource(Q.permissions.entries),U);var G=new YAHOO.widget.DataTable(t.id+"-view-node-store-permissions",[{key:"permission",label:t.msg("label.permissions-store-permission")},{key:"authority",label:t.msg("label.permissions-authority")},{key:"rel",label:t.msg("label.permissions-access")}],new YAHOO.util.LocalDataSource(Q.permissions.masks),U);N("-view-node-inherits-permissions",""+Q.permissions.inherit);N("-view-node-owner",Q.permissions.owner);f.setStyle(t.id+"-view-main","visibility","visible")},onNodeClick:function n(I,G){var H=G[1].nodeRef;this.refreshUIState({panel:"view",nodeRef:H})}});new ViewPanelHandler();return this};YAHOO.extend(Alfresco.ConsoleNodeBrowser,Alfresco.ConsoleTool,{options:{minSearchTermLength:1,maxSearchResults:100,shortQNames:true},currentNodeRef:"",store:"workspace://SpacesStore",searchTerm:'PATH:"/"',searchLanguage:"fts-alfresco",onComponentsLoaded:function i(){m.onContentReady(this.id,this.onReady,this,true)},onReady:function c(){Alfresco.ConsoleNodeBrowser.superclass.onReady.call(this)},onStateChanged:function g(s,p){var r=this.decodeHistoryState(p[1].state);if(r.panel){this.showPanel(r.panel)}if(r.search!==undefined&&this.currentPanelId==="search"){var o=r.search;this.searchTerm=o;var q=r.lang;this.searchLanguage=q;var n=r.store;this.store=n;this.updateCurrentPanel()}if(r.nodeRef&&(this.currentPanelId==="view")){this.currentNodeRef=r.nodeRef;this.updateCurrentPanel()}},onSearchClick:function j(s,q){var p=f.get(this.id+"-search-text");var o=YAHOO.lang.trim(p.value);var r=this.widgets.langMenuButton.get("value");var n=this.widgets.storeMenuButton.get("value");if(o.length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this._msg("message.minimum-length",this.options.minSearchTermLength)});return}this.refreshUIState({search:o,lang:r,store:n})},onViewNodeClick:function l(p,n){var o=n[1].nodeRef;this.refreshUIState({panel:"view",nodeRef:o})},onGoBackClick:function h(o,n){this.refreshUIState({panel:"search"})},encodeHistoryState:function a(p){var n={};if(this.currentPanelId!==""){n.panel=this.currentPanelId}if(this.currentNodeRef!==""){n.nodeRef=this.currentNodeRef}if(this.searchTerm!==undefined){n.search=this.searchTerm}if(this.searchLanguage!==undefined){n.lang=this.searchLanguage}if(this.store!==undefined){n.store=this.store}var o="";if(p.panel||n.panel){o+="panel="+encodeURIComponent(p.panel?p.panel:n.panel)}if(p.nodeRef||n.nodeRef){if(o.length!==0){o+="&"}o+="nodeRef="+encodeURIComponent(p.nodeRef?p.nodeRef:n.nodeRef)}if(p.search!==undefined||n.search!==undefined){if(o.length!==0){o+="&"}o+="search="+encodeURIComponent(p.search!==undefined?p.search:n.search)}if(p.lang!==undefined||n.lang!==undefined){if(o.length!==0){o+="&"}o+="lang="+encodeURIComponent(p.lang!==undefined?p.lang:n.lang)}if(p.store!==undefined||n.store!==undefined){if(o.length!==0){o+="&"}o+="store="+encodeURIComponent(p.store!==undefined?p.store:n.store)}return o},_msg:function d(n){return Alfresco.util.message.call(this,n,"Alfresco.ConsoleNodeBrowser",Array.prototype.slice.call(arguments).slice(1))},_qnamePropertyName:function k(){return this.options.shortQNames==true?"prefixedName":"name"}})})();