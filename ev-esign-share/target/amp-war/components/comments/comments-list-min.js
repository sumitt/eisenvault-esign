(function(){var a=YAHOO.util.Dom,u=YAHOO.util.Selector;var s=Alfresco.util.encodeHTML,d=Alfresco.util.userProfileLink,c=Alfresco.Share.userAvatar;Alfresco.CommentsList=function r(A){Alfresco.CommentsList.superclass.constructor.call(this,"Alfresco.CommentsList",A,["datasource","datatable","paginator","history","animation"]);YAHOO.Bubbling.on("editorInitialized",this.onEditorInitialized,this);YAHOO.Bubbling.on("commentNode",this.onCommentNode,this);YAHOO.Bubbling.on("versionReverted",function(){this.widgets.alfrescoDataTable.reloadDataTable()},this);YAHOO.Bubbling.on("metadataRefresh",function(){this.widgets.alfrescoDataTable.reloadDataTable()},this);this.busy=false;this.hashChecked=false;return this};YAHOO.extend(Alfresco.CommentsList,Alfresco.component.Base,{options:{nodeRef:null,siteId:null,activity:null,editorConfig:{}},busy:null,hashChecked:null,onReady:function o(){var A=document.createElement("div");a.addClass(A,"comments-list");a.addClass(A,"hidden");a.get(this.id+"-body").appendChild(A);this.widgets.editFormWrapper=A;YAHOO.util.Event.addListener(window,"resize",function(){if(this.currentEditedRowId){this.synchronizeElements(this.widgets.editFormWrapper,this.currentEditedRowId+"-form-container")}this.resizeCommentDetails()},this,true);this.setupCommentList();this.setupAddCommentForm()},resizeCommentDetails:function i(){var D=a.get(this.id+"-body").offsetWidth,E=YAHOO.util.Selector.query("div.comment-details",this.id+"-body");if(E.length!=0){var B=window.getComputedStyle(E[0],null).getPropertyValue("padding-left").replace("px",""),A=window.getComputedStyle(E[0],null).getPropertyValue("padding-right").replace("px","");D=D-B-A}for(var C=0;C<E.length;C++){E[C].style.width=D+"px"}},setupCommentList:function z(){var A=Alfresco.constants.URL_SERVICECONTEXT+"components/node/"+this.options.nodeRef.replace(":/","")+"/comments?reverse=true";this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:A,pagingResolver:function(B,C){return"startIndex="+B+"&pageSize="+C},config:{responseSchema:{resultsList:"items",metaFields:{paginationRecordOffset:"startIndex",paginationRowsPerPage:"pageSize",totalRecords:"total"}}},doBeforeParseData:this.bind(this.handlePermissions)},dataTable:{container:this.id+"-comments-list",columnDefinitions:[{key:"comment",sortable:false,formatter:this.bind(this.renderCellComment)}],config:{MSG_EMPTY:this.msg("message.noComments")}},paginator:{history:false,config:{containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.maxItems}}});this.widgets.alfrescoDataTable.getDataTable().subscribe("beforeRenderEvent",function(){a.removeClass(u.query("hr.hidden"),"hidden")},this,this);this.widgets.alfrescoDataTable.getDataTable().subscribe("renderEvent",function(){this.resizeCommentDetails()},this,this)},handlePermissions:function e(C,A){var B=A.nodePermissions||{};if(B.create){a.removeClass(this.id+"-actions","hidden")}else{a.addClass(this.id+"-actions","hidden")}return A},setupAddCommentForm:function m(){a.get(this.id+"-add-form-container").innerHTML=this.formMarkup(this.id+"-add",Alfresco.constants.USERNAME,null);this.widgets.addCommentEditor=this.setupCommentForm(this.id+"-add",this.options.nodeRef,false).editor},setupCommentForm:function g(E,I,A){var J=E+"-form",H=a.get(E+"-form-container"),C;if(A){C="api/comment/node/"+I.replace(":/","")}else{C="api/node/"+I.replace(":/","")+"/comments"}a.get(J).setAttribute("action",Alfresco.constants.PROXY_URI+C);var F=new YAHOO.widget.Button(E+"-submit",{type:"submit"});F.set("label",this.msg(A?"button.save":"button.addComment"));F.addClass("alf-primary-button");var D=new YAHOO.widget.Button(E+"-cancel");D.subscribe("click",function(){if(this.widgets.commentForm!=null){this.widgets.commentForm.hideErrorContainer()}this.restoreEditForm()},this,true);D.set("label",this.msg("button.cancel"));var G=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,E+"-content",this.options.editorConfig);G.addPageUnloadBehaviour(this.msg("message.unsavedChanges.comment"));G.render();var L=(Alfresco.constants.HTML_EDITOR==="YAHOO.widget.SimpleEditor")?"editorKeyUp":"onKeyUp";G.subscribe(L,function(M){if(G.getContent().length<20||!this.widgets.commentForm.isValid()){G.save();this.widgets.commentForm.validate()}},this,true);if(this.widgets.commentForm!=null){this.widgets.commentForm.hideErrorContainer()}var B=new Alfresco.forms.Form(J);this.widgets.commentForm=B;B.addValidation(E+"-content",this.contentValidation,G);B.setSubmitElements(F);B.setAjaxSubmitMethod(A?Alfresco.util.Ajax.PUT:Alfresco.util.Ajax.POST);B.setAJAXSubmit(true,{successCallback:{fn:function K(M,N){this.restoreEditForm();a.addClass(H,"hidden");this._releaseBusy();this.widgets.alfrescoDataTable.reloadDataTable();D.set("disabled",false)},scope:this},failureMessage:this.msg("message.savecomment.failure"),failureCallback:{fn:function K(M,N){this._releaseBusy();D.set("disabled",false)},scope:this}});B.setSubmitAsJSON(true);B.doBeforeFormSubmit={fn:function(M){this._setBusy(this.msg("message.wait"));D.set("disabled",true);G.save();G.getEditor().undoManager.clear();G.getEditor().nodeChanged()},scope:this};B.doBeforeAjaxRequest={fn:function(M,N){if(this.options.activity){M.dataObj.itemTitle=this.options.activity.itemTitle;M.dataObj.page=this.options.activity.page;M.dataObj.pageParams=YAHOO.lang.JSON.stringify(this.options.activity.pageParams)}return true},scope:this};B.init();return{form:B,editor:G}},contentValidation:function f(D,A,C,B){A.save();return Alfresco.forms.validation.mandatory(D,null,C,B)},restoreEditForm:function n(){if(this.currentEditedRowId){var D=a.get(this.currentEditedRowId+"-form-container"),A=a.get(this.currentEditedRowId+"-comment-container");if(D&&A){a.removeClass(D.parentNode,"theme-bg-color-4");a.addClass(D,"hidden");a.removeClass(A,"hidden");a.addClass(this.widgets.editFormWrapper,"hidden")}}a.addClass(this.id+"-add-form-container","hidden");a.removeClass(this.widgets.onAddCommentClick.get("element"),"hidden");if(this.widgets.alfrescoDataTable.lastResultCount>this.options.maxItems){var C=this.widgets.alfrescoDataTable.widgets.paginator._containers,B=0;for(B=0;B<C.length;++B){a.removeClass(C[B],"hidden")}}},renderCellComment:function b(E,C,G,H){var D=C.getData(),A="",F=this.id+"-"+C.getId(),B=D.permissions;A+='<div id="'+F+'-comment-container" class="comment-details">';A+='   <div class="icon">'+c(D.author.username)+"</div>";A+='   <div class="details">';A+='      <span class="info">';A+=d(D.author.username,D.author.firstName+" "+D.author.lastName,'class="theme-color-1"')+" ";A+=Alfresco.util.relativeTime(Alfresco.util.fromISO8601(D.modifiedOnISO))+"<br/>";A+="      </span>";A+='      <span class="comment-actions">';if(B.edit){A+='       <a href="#" name=".onEditCommentClick" rel="'+C.getId()+'" title="'+this.msg("link.editComment")+'" class="'+this.id+' edit-comment">&nbsp;</a>'}if(B["delete"]){A+='       <a href="#" name=".onConfirmDeleteCommentClick" rel="'+C.getId()+'" title="'+this.msg("link.deleteComment")+'" class="'+this.id+' delete-comment">&nbsp;</a>'}A+="      </span>";A+='      <div class="comment-content">'+(D.content||"")+"</div>";A+="   </div>";A+='   <div class="clear"></div>';A+="</div>";A+='<div id="'+F+'-form-container" class="comment-form hidden">';A+="   &nbsp;<!-- EMPTY SPACE FOR FLOATING COMMENT FORM -->";A+="</div>";E.innerHTML=A},formMarkup:function p(C,B,D){var A="";A+='<div id="'+C+'-actual-form-container" class="comment-form">';A+='   <h2 class="thin dark">'+this.msg(D?"header.edit":"header.add")+"</h2>";A+=c(B);A+='   <form id="'+C+'-form" method="POST" action="">';if(this.options.siteId){A+='      <input type="hidden" name="site" value="'+encodeURIComponent(this.options.siteId)+'" />'}A+='      <textarea name="content" id="'+C+'-content" style="width: 100%">'+(D||"")+"</textarea>";A+='      <div id="'+C+'-help" class="help-text hidden">'+this.msg("link.help")+"</div>";A+='      <div class="buttons">';A+='         <input type="submit" id="'+C+'-submit" value=""/>';A+='         <input type="reset"  id="'+C+'-cancel" value="" />';A+='         <a href="#" name=".onHelpLinkClick" title="'+this.msg("link.showHelp")+'" class="'+this.id+' help-link" style="float:right;">&nbsp;&nbsp;&nbsp;</a>';A+="      </div>";A+="   </form>";A+='   <div class="clear"></div>';A+="</div>";return A},onEditorInitialized:function k(){if(!this.hashChecked&&window.location.hash=="#comment"){this.hashChecked=true;this.onAddCommentClick(true);if(YAHOO.env.ua.ie==11){window.scrollTo(0,a.get(this.id+"-add-comment").offsetTop)}else{a.get(this.id+"-add-comment").scrollIntoView()}}},onCommentNode:function w(B,A){if(this.options.nodeRef==A[1]){this.onAddCommentClick();if(YAHOO.env.ua.ie==11){window.scrollTo(0,a.get(this.id+"-add-comment").offsetTop)}else{a.get(this.id+"-add-comment").scrollIntoView()}}},onAddCommentClick:function q(B){this.restoreEditForm();if(B==null){this.setupAddCommentForm()}a.addClass(this.widgets.onAddCommentClick.get("element"),"hidden");this.widgets.addCommentEditor.setContent("");this.widgets.addCommentEditor.save();a.removeClass(this.id+"-add-form-container","hidden");this.widgets.addCommentEditor.focus();if(document.activeElement.nodeName!="IFRAME"){var A=this.widgets.addCommentEditor;window.setTimeout(function(){A.focus()},500)}},onHelpLinkClick:function y(){if(a.hasClass(this.id+"-add-help","hidden")){a.removeClass(this.id+"-add-help","hidden")}else{a.addClass(this.id+"-add-help","hidden")}},onEditCommentClick:function t(C){this.restoreEditForm();var G=this.widgets.alfrescoDataTable.getData(C),E=this.id+"-"+C,D=a.get(E+"-form-container"),F=a.get(E+"-comment-container");this.currentEditedRowId=E;a.addClass(D.parentNode,"theme-bg-color-4");a.addClass(F,"hidden");a.removeClass(D,"hidden");this.widgets.editFormWrapper.innerHTML=this.formMarkup(E,G.author.username,G.content);this.widgets.editCommentEditor=this.setupCommentForm(E,G.nodeRef,true).editor;this.synchronizeElements(this.widgets.editFormWrapper,D);a.removeClass(this.widgets.editFormWrapper,"hidden");var B=this.widgets.alfrescoDataTable.widgets.paginator._containers,A=0;for(A=0;A<B.length;++A){a.addClass(B[A],"hidden")}this.widgets.editCommentEditor.focus()},synchronizeElements:function x(D,A){var C=new YAHOO.util.Element(A),B=new YAHOO.util.Element(D),E=YAHOO.util.Dom.getRegion(C.get("id"));B.setStyle("position","absolute");B.setStyle("left",E.left+"px");B.setStyle("top",E.top+"px");B.setStyle("width",E.width+"px");B.setStyle("height",E.height+"px")},onConfirmDeleteCommentClick:function v(C){var E=this.widgets.alfrescoDataTable.getData(C),D=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete"),buttons:[{text:this.msg("button.delete"),handler:function B(){this.destroy();D.deleteComment.call(D,E)}},{text:this.msg("button.cancel"),handler:function A(){this.destroy()},isDefault:true}]})},deleteComment:function l(G){if(!this._setBusy(this.msg("message.wait"))){return}var F=function D(H,J){this._releaseBusy();if(this.widgets.alfrescoDataTable.lastResultCount==1&&this.widgets.alfrescoDataTable.currentSkipCount>0){var I=this.widgets.alfrescoDataTable;I.currentSkipCount=I.currentSkipCount-I.currentMaxItems}this.widgets.alfrescoDataTable.reloadDataTable()};var C=function A(H,I){this._releaseBusy()};var B=Alfresco.constants.PROXY_URI+"api/comment/node/"+G.nodeRef.replace(":/",""),E=false;if(this.options.siteId){B+=E?"&":"?";B+="site="+encodeURIComponent(this.options.siteId);E=true}if(this.options.activity){B+=E?"&":"?";B+="itemTitle="+encodeURIComponent(this.options.activity.itemTitle)+"&";B+="page="+encodeURIComponent(this.options.activity.page)+"&";B+="pageParams="+encodeURIComponent(YAHOO.lang.JSON.stringify(this.options.activity.pageParams));E=true}Alfresco.util.Ajax.jsonDelete({url:B,successMessage:this.msg("message.delete.success"),successCallback:{fn:F,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:C,scope:this}})},_setBusy:function h(A){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:A,spanClass:"wait",displayTime:0});return true},_releaseBusy:function j(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}}})})();