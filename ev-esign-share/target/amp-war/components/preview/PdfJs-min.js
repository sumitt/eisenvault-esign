(function(){var d=0;var Y=96/72;var A=0.25;var ah=4;var z=YAHOO.util.Dom,P=YAHOO.util.Event,ab=YAHOO.util.Element;var e=Alfresco.util.encodeHTML;Alfresco.WebPreview.prototype.Plugins.PdfJs=function(aC,aB){this.pages=[];this.pageText=[];this.widgets={};this.documentConfig={};this.wp=aC;this.wp.id=aC.id;this.attributes=YAHOO.lang.merge(Alfresco.util.deepCopy(this.attributes),aB);this.onPdfLoaded=new YAHOO.util.CustomEvent("pdfLoaded",this);this.onResize=new YAHOO.util.CustomEvent("resize",this);return this};Alfresco.WebPreview.prototype.Plugins.PdfJs.prototype={attributes:{src:null,srcMaxSize:"",skipbrowsertest:"false",defaultScale:"auto",scaleDelta:"1.1",autoMinScale:"0.65",autoMinScaleMobile:"0.525",autoMaxScale:"1.25",pageLayout:"multi",disableTextLayer:"false",useLocalStorage:"true",autoSearch:"false",progressiveLoading:"false",disabledPageLinking:true},pdfDocument:null,pageNum:1,pages:[],pageText:[],numPages:0,widgets:{},maximized:false,documentConfig:{},inDashlet:false,workerSrc:"",currentScaleSelection:null,report:function h(){var aB=true,aD=this.attributes.skipbrowsertest==="true",aC=this.attributes.srcMaxSize;if(aC.match(/^\d+$/)&&this.wp.options.size>parseInt(aC)){return this.wp.msg("PdfJs.tooLargeFile",Alfresco.util.formatFileSize(this.wp.options.size),parseInt(aC))}if(!aD){if(this._isCanvasSupported()){if(YAHOO.env.ua.webkit>0&&YAHOO.env.ua.webkit<534){aB=false}if(YAHOO.env.ua.ie>0&&YAHOO.env.ua.ie<10){aB=false}if(YAHOO.env.ua.gecko>0&&YAHOO.env.ua.gecko<5){aB=false}}else{aB=false}}if(!aB){return this.wp.msg("label.browserReport","&lt;canvas&gt; element")}},_isCanvasSupported:function n(){var aB=document.createElement("canvas");return !!(aB.getContext&&aB.getContext("2d"))},display:function X(){this.inDashlet=z.getAncestorByClassName(this.wp.getPreviewerElement(),"body")!=null||z.getAncestorByClassName(this.wp.getPreviewerElement(),"yui-panel")!=null;Alfresco.util.YUILoaderHelper.require(["tabview"],this.onComponentsLoaded,this);Alfresco.util.YUILoaderHelper.loadComponents();this.wp.getPreviewerElement().innerHTML="";return null},onComponentsLoaded:function f(){this.workerSrc=Alfresco.constants.URL_CONTEXT+"res/components/preview/pdfjs/pdf.worker"+(Alfresco.constants.DEBUG?".js":"-min.js");var aB=document.getElementsByTagName("script");for(var aE=0,aD=aB.length;aE<aD;aE++){if(aB[aE].src.indexOf("components/preview/pdfjs/pdf.worker_")>-1){this.workerSrc=aB[aE].src;break}}this._loadDocumentConfig();this.attributes.disabledPageLinking=(Alfresco.constants.PAGEID==="document-details")?false:true;var aC=Alfresco.util.getQueryStringParameters(window.location.hash.replace("#",""));if(this.disabledPageLinking){this.pageNum=this.documentConfig.pageNum?parseInt(this.documentConfig.pageNum):this.pageNum}else{this.pageNum=aC.page||(this.documentConfig.pageNum?parseInt(this.documentConfig.pageNum):this.pageNum)}this.pageNum=parseInt(this.pageNum);Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/preview/pdfjs?htmlid="+encodeURIComponent(this.wp.id),successCallback:{fn:this.onViewerLoaded,scope:this},failureMessage:this.wp.msg("error.viewerload")});P.addListener(window,"resize",this.onRecalculatePreviewLayout,this,true);P.addListener(window,"hashchange",this.onWindowHashChange,this,true);P.addListener(window,"beforeunload",this.onWindowUnload,this,true)},onViewerLoaded:function p(aH){this.wp.getPreviewerElement().innerHTML=aH.serverResponse.responseText;this.controls=z.get(this.wp.id+"-controls");this.pageNumber=z.get(this.wp.id+"-pageNumber");this.sidebar=z.get(this.wp.id+"-sidebar");this.viewer=z.get(this.wp.id+"-viewer");if(this.attributes.pageLayout=="multi"){z.addClass(this.viewer,"multiPage")}this.widgets.sidebarButton=Alfresco.util.createYUIButton(this,"sidebarBtn",this.onSidebarToggle,{type:"checkbox",disabled:true},this.wp.id+"-sidebarBtn");this.widgets.nextButton=Alfresco.util.createYUIButton(this,"next",this.onPageNext,{disabled:true},this.wp.id+"-next");this.widgets.previousButton=Alfresco.util.createYUIButton(this,"previous",this.onPagePrevious,{disabled:true},this.wp.id+"-previous");P.addListener(this.wp.id+"-pageNumber","change",this.onPageChange,this,true);this.widgets.zoomOutButton=Alfresco.util.createYUIButton(this,"zoomOut",this.onZoomOut,{disabled:true},this.wp.id+"-zoomOut");this.widgets.zoomInButton=Alfresco.util.createYUIButton(this,"zoomIn",this.onZoomIn,{disabled:true},this.wp.id+"-zoomIn");this.widgets.scaleMenu=new YAHOO.widget.Button(this.wp.id+"-scaleSelectBtn",{type:"menu",menu:this.wp.id+"-scaleSelect",disabled:true});this.widgets.scaleMenu.getMenu().subscribe("click",this.onZoomChange,null,this);var aB=[{text:this.wp.msg("link.download"),value:"",onclick:{fn:this.onDownloadClick,scope:this}}];if(this.attributes.src){aB.push({text:this.wp.msg("link.downloadPdf"),value:"",onclick:{fn:this.onDownloadPDFClick,scope:this}})}this.widgets.downloadButton=new YAHOO.widget.Button(this.wp.id+"-download",{type:"menu",menu:aB});if(Alfresco.constants.PAGEID==="document-details"||Alfresco.constants.PAGEID==="documentlibrary"||window.location.pathname.match("/document-details$")){this.widgets.maximize=Alfresco.util.createYUIButton(this,"fullpage",this.onMaximizeClick,{title:this.wp.msg("button.maximize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl"))},this.wp.id+"-fullpage");z.getElementsByClassName("maximizebutton","span",this.controls,function aG(aI){z.setStyle(aI,"display","inline")});z.getElementsByClassName("maximizebuttonSep","span",this.controls,function aG(aI){z.setStyle(aI,"display","inline")})}if(Alfresco.constants.PAGEID==="document-details"){z.getElementsByClassName("linkbutton","span",this.controls,function aG(aI){z.setStyle(aI,"display","inline")});this.widgets.linkBn=Alfresco.util.createYUIButton(this,"link",this.onLinkClick,{type:"checkbox"},this.wp.id+"-link")}P.addListener(this.wp.id+"-findInput","change",this.onFindChange,this,true);var aF=this;P.addListener(this.wp.id+"-findInput","keypress",function(aI){if(aI.keyCode==13){P.stopEvent(aI);aF.onFindChange("find")}});this.widgets.previousSearchButton=Alfresco.util.createYUIButton(this,"findPrevious",this.onFindChange,{},this.wp.id+"-findPrevious");this.widgets.nextSearchButton=Alfresco.util.createYUIButton(this,"findNext",this.onFindChange,{},this.wp.id+"-findNext");this.widgets.searchHighlight=Alfresco.util.createYUIButton(this,"findHighlightAll",this.onFindChangeHighlight,{type:"checkbox"},this.wp.id+"-findHighlightAll");this.widgets.searchMatchCase=Alfresco.util.createYUIButton(this,"findMatchCase",this.onFindChangeMatchCase,{type:"checkbox"},this.wp.id+"-findMatchCase");this.widgets.searchBarToggle=Alfresco.util.createYUIButton(this,"searchBarToggle",this.onToggleSearchBar,{type:"checkbox",disabled:true,title:this.wp.msg("button.search.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl"))},this.wp.id+"-searchBarToggle");this.onPdfLoaded.subscribe(function aC(aJ,aI){this.widgets.sidebarButton.set("disabled",false);this.widgets.scaleMenu.set("disabled",false);this.widgets.searchBarToggle.set("disabled",false)},this,true);this._setPreviewerElementHeight();this._setViewerHeight();this._loadPdf();if(Alfresco.constants.PAGEID==="document-details"){var aE=function aE(aJ,aI){var aK=aI[1];if((aK.ctrlKey||aK.metaKey)&&this.widgets.searchBarToggle){P.stopEvent(aK);aK.newValue=(!this.widgets.searchDialog||!this.widgets.searchDialog.cfg.getProperty("visible"));this.widgets.searchBarToggle.set("checked",!this.widgets.searchBarToggle.get("checked"))}};var aD=function aD(aJ,aI){var aK=aI[1];if(aK.ctrlKey||aK.metaKey){P.stopEvent(aK);this.onFullScreen(aK)}};new YAHOO.util.KeyListener(document,{keys:37},{fn:this.onPagePrevious,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:39},{fn:this.onPageNext,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:70,ctrl:true},{fn:aE,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:13,ctrl:true},{fn:aD,scope:this,correctScope:true}).enable();if(YAHOO.env.ua.os=="macintosh"){new YAHOO.util.KeyListener(document,{keys:13},{fn:aD,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:70},{fn:aE,scope:this,correctScope:true}).enable()}P.addListener(window,"fullscreenchange",this.onFullScreenChange,this,true);P.addListener(window,"mozfullscreenchange",this.onFullScreenChange,this,true);P.addListener(window,"webkitfullscreenchange",this.onFullScreenChange,this,true)}new YAHOO.util.KeyListener(document,{keys:27},{fn:function(aI){if(this.maximized){this.onMaximizeClick()}},scope:this,correctScope:true}).enable()},_setPreviewerElementHeight:function ai(){if(!this.maximized){var aF;if(this.inDashlet){z.setStyle(this.wp.getPreviewerElement(),"height",(z.getClientHeight()-64)+"px")}else{if(aF=z.getAncestorByClassName(this.wp.getPreviewerElement(),"dijitDialogPaneContent")){var aG=z.getStyle(aF,"height");var aB=(parseInt(aG)-42)+"px";z.setStyle(this.wp.getPreviewerElement(),"height",aB)}else{var aE=new YAHOO.util.Element(this.wp.getPreviewerElement()),aD=z.getDocumentHeight(),aC=z.getClientHeight();var aB=((aD<aC)?aD:aC)-220;z.setStyle(this.wp.getPreviewerElement(),"height",aB+"px")}}}else{if(this.fullscreen){}else{z.setStyle(this.wp.getPreviewerElement(),"height",(window.innerHeight||z.getViewportHeight()).toString()+"px")}}},_setViewerHeight:function an(){var aE=z.getRegion(this.viewer.parentNode),aJ=z.getRegion(this.controls),aB=!this.fullscreen?aJ.height:0,aC=aE.height-aB-1;if(aC===0){if(!this.maximized){var aF;if(aF=z.getAncestorByClassName(this.wp.getPreviewerElement(),"dijitDialogPaneContent")){var aG=z.getStyle(aF,"height");var aI=(parseInt(aG)-42-10-aB-1)+"px";z.setStyle(this.wp.getPreviewerElement(),"height",aI)}else{var aD=new YAHOO.util.Element(this.wp.getPreviewerElement()),aK=z.getDocumentHeight(),aH=z.getClientHeight();var aI=((aK<aH)?aK:aH)-220;aC=aI-10-aB-1}}else{aC=z.getViewportHeight()-aB-1}}if(!this.fullscreen){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Setting viewer height to "+aC+"px (toolbar "+aB+"px, container "+aE.height+"px")}z.setStyle(this.viewer,"height",aC.toString()+"px");z.setStyle(this.sidebar,"height",aC.toString()+"px")}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Setting viewer height to 100% (full-screen)")}z.setStyle(this.viewer,"height","100%")}},_loadPdf:function V(aD){this.wp.options.name=this.wp.options.name.replace(/[^\w_\-\. ]/g,"");var aC=this,aB=this.attributes.src?this.wp.getThumbnailUrl(this.attributes.src):this.wp.getContentUrl();if(aB.substr(0,4).toLowerCase()!=="http"){aB=window.location.protocol+"//"+window.location.host+aB}aD=aD||{};aD.url=aB;if(typeof window.Spinner==="function"){this.spinner=new Spinner({lines:13,length:7,width:4,radius:10,corners:1,rotate:0,color:"#666",speed:1,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"}).spin(this.viewer);this.onPdfLoaded.subscribe(function aE(aG,aF){this.spinner.stop()},this,true)}else{Alfresco.logger.error("spinner.js is not loaded!")}PDFJS.workerSrc=this.workerSrc;PDFJS.cMapUrl="./cmaps/";PDFJS.cMapPacked=true;if(this.attributes.progressiveLoading=="true"&&PDFJS.disableRange!=true){PDFJS.disableRange=false;PDFJS.disableAutoFetch=false}else{PDFJS.disableRange=true}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Using PDFJS.disableRange="+PDFJS.disableRange+" PDFJS.disableAutoFetch:"+PDFJS.disableAutoFetch);Alfresco.logger.debug("Loading PDF file from "+aB)}PDFJS.getDocument(aD).then(Alfresco.util.bind(this._onGetDocumentSuccess,this),Alfresco.util.bind(this._onGetDocumentFailure,this))},_onGetDocumentSuccess:function ak(aB){this.pdfDocument=aB;this.numPages=this.pdfDocument.numPages;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering PDF with fingerprint "+aB.fingerprint+" for "+this.wp.options.name)}this._renderPdf();this._updatePageControls();this.onPdfLoaded.fire(aB)},_onGetDocumentFailure:function af(aM,aE){if(this.spinner){this.spinner.stop()}if(aE&&aE.name==="PasswordException"){var aG="prompt.password.text";if(aE.code==="incorrectpassword"){aG="error.incorrectpassword"}if(aE.code==="needpassword"||aE.code==="incorrectpassword"){var aF=this,aC=Alfresco.util.generateDomId(),aJ=Alfresco.util.bind(function(aN){if(aN&&aN.length>0){this._loadPdf({password:aN})}},this),aD=Alfresco.util.PopupManager.getUserInput({title:this.wp.msg("prompt.password.title"),html:'<label for="'+aC+'">'+e(this.wp.msg(aG))+'</label><br/><br/><input id="'+aC+'" tabindex="0" type="password" value=""/>',buttons:[{text:Alfresco.util.message("button.ok",this.name),handler:function aK(){aJ(z.get(aC).value);this.destroy()},isDefault:true},{text:Alfresco.util.message("button.cancel",this.name),handler:function aH(){this.destroy()}}]}),aI=aD.getButtons()[0];YAHOO.util.Event.addListener(aC,"keyup",function(aN,aO){if(aO!=null){aO.set("disabled",YAHOO.lang.trim(this.value||this.text||"").length==0)}},aI);new YAHOO.util.KeyListener(aC,{keys:[YAHOO.util.KeyListener.KEY.ENTER]},function aL(aN){aJ(z.get(aC).value);aD.destroy()}).enable();if(z.get(aC)){z.get(aC).focus()}return}}var aB=this.wp.msg("error.pdfload");if(aE&&aE.name==="InvalidPDFException"){aB=this.wp.msg("error.invalidpdf")}Alfresco.util.PopupManager.displayMessage({text:aB});Alfresco.logger.error("Could not load PDF due to error "+aE.name+" (code "+aE.code+"): "+aM)},_renderPdf:function aq(){var aE=[],aF={},aB=this.numPages;for(var aH=1;aH<=aB;aH++){aE.push(this.pdfDocument.getPage(aH))}var aK=Promise.all(aE);var aJ=this.pdfDocument.getDestinations();var aD=Alfresco.util.bind(function(aR){var aL=this;this.documentView=new H(this.wp.id+"-viewer",{name:"documentView",pageLayout:this.attributes.pageLayout,currentScale:d,defaultScale:this.documentConfig.scale?this.documentConfig.scale:this.attributes.defaultScale,disableTextLayer:this.attributes.disableTextLayer=="true"||YAHOO.env.ua.ios||YAHOO.env.ua.android,autoMinScale:parseFloat(z.getClientWidth()>1024?this.attributes.autoMinScale:this.attributes.autoMinScaleMobile),autoMaxScale:parseFloat(this.attributes.autoMaxScale),pdfJsPlugin:aL,pdfDocument:this.pdfDocument});this.documentView.onScrollChange.subscribe(function aP(){var aS=this.documentView.getScrolledPageNumber();if(this.pageNum!=aS){this.pageNum=aS;this._updatePageControls();this.documentView.setActivePage(this.pageNum)}},this,true);this.thumbnailView=null;this.pages=aR;this.documentView.addPages(aR);for(var aN=0;aN<aR.length;aN++){var aO=aR[aN],aQ=aO.ref;aF[aQ.num+" "+aQ.gen+" R"]=aN}this.documentView.render();if(this.pageNum>this.pdfDocument.numPages){this.pageNum=this.pdfDocument.numPages;this._updatePageControls()}this.documentView.scrollTo(this.pageNum);this.documentView.setActivePage(this.pageNum);this._updateZoomControls();z.get(this.wp.id+"-numPages").textContent=this.numPages;z.setAttribute(this.wp.id+"-pageNumber","max",this.numPages);z.setAttribute(this.wp.id+"-pageNumber","disabled",this.numPages>1?null:"disabled");z.get(this.wp.id+"-pageNumber").removeAttribute("disabled");if(this.attributes.autoSearch=="true"&&document.referrer&&document.referrer.indexOf("/search?")>0){var aM=Alfresco.util.getQueryStringParameter("t",document.referrer);if(aM){this.widgets.searchBarToggle.set("checked",true);z.get(this.wp.id+"-findInput").value=aM;this.onFindChange("find")}}},this);var aG=Alfresco.util.bind(function(aL){this.destinations=aL},this);var aI=Alfresco.util.bind(function(aL){this._addOutline(aL)},this);var aC=Alfresco.util.bind(function(){this.pdfDocument.getOutline().then(aI)},this);aK.then(aD);this.pagesRefMap=aF;aJ.then(aG);Promise.all([aK,aJ]).then(aC)},_updatePageControls:function ac(){this.pageNumber.value=this.pageNum;this.widgets.nextButton.set("disabled",this.pageNum>=this.pdfDocument.numPages);this.widgets.previousButton.set("disabled",this.pageNum<=1)},_updateZoomControls:function U(aC){var aB=this.documentView.currentScale;this.widgets.zoomInButton.set("disabled",aB*this.attributes.scaleDelta>ah);this.widgets.zoomOutButton.set("disabled",aB/this.attributes.scaleDelta<A);this.widgets.scaleMenu.set("label",""+Math.round(aB*100)+"%")},_scrollToPage:function aa(aB){this.documentView.removeScrollListener();this.documentView.scrollTo(aB);this.documentView.setActivePage(this.pageNum);this.pageNum=aB;this._updatePageControls();if(this.thumbnailView&&this.thumbnailView.pages&&this.thumbnailView.pages[0]&&this.thumbnailView.pages[0].container){this.thumbnailView.setActivePage(this.pageNum)}YAHOO.lang.later(50,this.documentView,this.documentView.addScrollListener)},_addOutline:function ax(aB){var aH=z.get(this.wp.id+"-outlineView");if(aB&&aB.length>0){var aG=[{parent:aH,items:aB}];while(aG.length>0){var aC=aG.shift();var aF,aE=aC.items.length;for(aF=0;aF<aE;aF++){var aK=aC.items[aF];var aD=document.createElement("div");aD.className="outlineItem";var aJ=document.createElement("a");z.setAttribute(aJ,"href","#");YAHOO.util.Event.addListener(aJ,"click",function(aM,aL){YAHOO.util.Event.stopEvent(aM);this._navigateTo(aL)},aK.dest,this);aJ.textContent=aK.title;aD.appendChild(aJ);if(aK.items.length>0){var aI=document.createElement("div");aI.className="outlineItems";aD.appendChild(aI);aG.push({parent:aI,items:aK.items})}aC.parent.appendChild(aD)}}}else{aH.innerHTML="<p>"+this.wp.msg("msg.noOutline")+"</p>"}},_navigateTo:function b(aC){if(typeof aC==="string"){aC=this.destinations[aC]}if(aC instanceof Array){var aD=aC[0];var aB=aD instanceof Object?this.pagesRefMap[aD.num+" "+aD.gen+" R"]:(aD+1);if(aB>this.documentView.pages.length-1){aB=this.documentView.pages.length-1}if(typeof aB==="number"){this._scrollToPage(aB+1)}}},_loadDocumentConfig:function au(){if(this.attributes.useLocalStorage!="true"||!this._browserSupportsHtml5Storage()){this.documentConfig={}}else{var aB="org.alfresco.pdfjs.document."+this.wp.options.nodeRef.replace(":/","").replace("/",".")+".";this.documentConfig={pageNum:window.localStorage[aB+"pageNum"],scale:window.localStorage[aB+"scale"]};if(this.documentConfig.scale=="null"){this.documentConfig.scale=null}}},_browserSupportsHtml5Storage:function ay(){try{return"localStorage" in window&&window.localStorage!==null}catch(aB){return false}},onSidebarToggle:function al(aE){var aB=z.getStyle(this.sidebar,"display")=="block";z.setStyle(this.sidebar,"display",aB?"none":"block");if(aB){z.removeClass(this.viewer,"sideBarVisible")}else{z.addClass(this.viewer,"sideBarVisible");if(!this.thumbnailView){this.thumbnailView=new H(this.wp.id+"-thumbnailView",{name:"thumbnailView",pageLayout:"single",defaultScale:"page-width",disableTextLayer:true,pdfJsPlugin:this});this.thumbnailView.addPages(this.pages)}}this.documentView.alignRows();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.renderVisiblePages();var aD=function aD(aG,aF){YAHOO.util.Event.stopEvent(aG);this._scrollToPage(aF.pn)};this.widgets.tabview=this.widgets.tabview||new YAHOO.widget.TabView(this.wp.id+"-sidebarTabView");if(this.thumbnailView&&this.thumbnailView.pages.length>0&&!this.thumbnailView.pages[0].container){this.thumbnailView.render();for(var aC=0;aC<this.thumbnailView.pages.length;aC++){YAHOO.util.Event.addListener(this.thumbnailView.pages[aC].container,"click",function(aG,aF){this.thumbnailView.setActivePage(aF.pn);this.documentView.scrollTo(aF.pn)},{pn:aC+1},this)}this.thumbnailView.scrollTo(this.pageNum);this.thumbnailView.setActivePage(this.pageNum)}},onPagePrevious:function k(aB){if(this.pageNum<=1){return}this.pageNum--;this._scrollToPage(this.pageNum)},onPageNext:function L(aB){if(this.pageNum<this.pdfDocument.numPages){this.pageNum++;this._scrollToPage(this.pageNum)}},onFullScreen:function T(aC){var aB=this.viewer;if((document.fullScreenElement&&document.fullScreenElement!==null)||(!document.mozFullScreenElement&&!document.webkitFullScreenElement&&!document.webkitFullscreenElement)){P.removeListener(window,"resize",this.onRecalculatePreviewLayout,this,true);if(aB.requestFullScreen){aB.requestFullScreen()}else{if(aB.mozRequestFullScreen){aB.mozRequestFullScreen()}else{if(aB.webkitRequestFullScreen){aB.webkitRequestFullScreen(ab.ALLOW_KEYBOARD_INPUT)}}}}else{if(document.cancelFullScreen){document.cancelFullScreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}}}}},onFullScreenChange:function a(aB){if((document.fullScreenElement&&document.fullScreenElement!==null)||(!document.mozFullScreenElement&&!document.webkitFullScreenElement&&!document.webkitFullscreenElement)){Alfresco.logger.debug("Leaving full screen mode");this.fullscreen=false;this.documentView.fullscreen=false;this.documentView.setScale(this.oldScale);this._setViewerHeight();this.onResize.fire();this.documentView.alignRows();this._scrollToPage(this.pageNum);P.addListener(window,"resize",this.onRecalculatePreviewLayout,this,true)}else{Alfresco.logger.debug("Entering full screen mode");this.documentView.fullscreen=true;this.fullscreen=true;this.oldScale=this.documentView.currentScale;this.oldPageNum=this.pageNum;this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale("page-fit"));this.documentView.alignRows();this._scrollToPage(this.pageNum)}},onPageChange:function aw(aC){var aB=parseInt(aC.currentTarget.value);if(aB<1||aB>this.numPages){Alfresco.util.PopupManager.displayMessage({text:this.wp.msg("error.badpage")})}else{this.pageNum=aB;this._scrollToPage(this.pageNum)}},onToggleSearchBar:function N(aC){if(!this.widgets.searchDialog){this.widgets.searchDialog=new YAHOO.widget.SimpleDialog(this.wp.id+"-searchDialog",{close:false,draggable:false,effect:null,modal:false,visible:false,width:"265px",context:[this.viewer,"tr","tr",["beforeShow","windowResize"],[-20,3]],underlay:"none"});this.widgets.searchDialog.render();new YAHOO.util.KeyListener(z.get(this.wp.id+"-searchDialog"),{keys:27},{fn:function(aE,aD){if(this.widgets.searchBarToggle.get("checked")){var aF=aD[1];P.stopEvent(aF);this.widgets.searchBarToggle.set("checked",false)}},scope:this,correctScope:true}).enable()}if(this.widgets.linkBn&&this.widgets.linkBn.get("checked")===true){this.widgets.linkBn.set("checked",false)}if(aC.newValue===true){this.widgets.searchDialog.show();this.widgets.searchDialog.bringToTop();var aB=z.get(this.wp.id+"-findInput");aB.focus();aB.select();if(!q.pdfPageSource){q.initialize({pdfPageSource:this.documentView});q.resolveFirstPage()}q.reset();q.extractText()}else{this.widgets.searchDialog.hide();q.active=false}},onFindChangeMatchCase:function i(aB){this.onFindChange("casesensitivitychange")},onFindChangeHighlight:function v(aB){this.onFindChange("highlightallchange")},onFindChange:function ar(aI){var aH=z.get(this.wp.id+"-findInput").value;if(!aH){return}var aG=document.createEvent("CustomEvent"),aF=false,aE="find",aD=this.widgets.searchHighlight.get("checked"),aB=this.widgets.searchMatchCase.get("checked"),aC;if(aI.currentTarget){aC=aI.currentTarget.id}else{aC=aI}switch(aC){case this.wp.id+"-findNext":aE+="again";break;case this.wp.id+"-findPrevious":aE+="again";aF=true;break;case"highlightallchange":aE+="highlightallchange";break;case"casesensitivitychange":aE+="casesensitivitychange";break;default:if(aH===this.lastSearchQuery){aE+="again";break}else{break}}this.lastSearchQuery=aH;aG.initCustomEvent(aE,true,true,{query:aH,caseSensitive:aB,highlightAll:aD,findPrevious:aF});window.dispatchEvent(aG)},onZoomOut:function r(aC){var aB=Math.max(A,this.documentView.currentScale/this.attributes.scaleDelta);this.documentView.setScale(this.documentView.parseScale(aB));this._scrollToPage(this.pageNum);this._updateZoomControls()},onZoomIn:function Q(aC){var aB=Math.min(ah,this.documentView.currentScale*this.attributes.scaleDelta);this.documentView.setScale(this.documentView.parseScale(aB));this._scrollToPage(this.pageNum);this._updateZoomControls()},onZoomChange:function c(aD,aC){var aB=aC[0],aE=aC[1];this.currentScaleSelection=aE.value;this.documentView.setScale(this.documentView.parseScale(aE.value));this._scrollToPage(this.pageNum);this._updateZoomControls()},onDownloadClick:function am(aB){window.open(this.wp.getContentUrl(true).replace("api/node","slingshot/node"),"_blank")},onDownloadPDFClick:function W(aB){window.open(this.wp.getThumbnailUrl(this.attributes.src)+"&a=true","_blank")},onMaximizeClick:function y(aB){this.maximized=!this.maximized;if(this.maximized){z.addClass(this.wp.getPreviewerElement(),"fullPage");this.widgets.maximize.set("label",this.wp.msg("button.minimize"));this.widgets.maximize.set("title",this.wp.msg("button.minimize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl")))}else{z.removeClass(this.wp.getPreviewerElement(),"fullPage");this.widgets.maximize.set("label",this.wp.msg("button.maximize"));this.widgets.maximize.set("title",this.wp.msg("button.maximize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl")))}this._setPreviewerElementHeight();this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.alignRows();this.documentView.renderVisiblePages();if(this.thumbnailView){this.thumbnailView.renderVisiblePages()}if(this.widgets.searchDialog){this.widgets.searchDialog.align("tr","tr")}if(this.widgets.linkDialog){this.widgets.linkDialog.align("tr","tr")}},onLinkClick:function g(aI){var aH=this.wp.id+"-linkDialog",aF=aH+"-input";var aB=function aC(){var aM=this.widgets.linkDialogBg.get("checkedButton").get("id");var aL=window.location.href.replace(window.location.hash,"")+(aM.indexOf("-doc")>0?"":"#page="+this.pageNum);var aK=z.get(aF);aK.value=aL;aK.focus();aK.select()};if(!this.widgets.linkDialog){var aJ=new YAHOO.widget.SimpleDialog(aH,{close:false,draggable:false,effect:null,modal:false,visible:false,context:[this.viewer,"tr","tr",["beforeShow","windowResize"],[-20,3]],width:"40em",underlay:"none"});var aD=window.location.href.replace(window.location.hash,"")+"#page="+this.pageNum;aJ.render();new YAHOO.util.KeyListener(z.get(aH),{keys:27},{fn:function(aL,aK){if(this.widgets.linkBn.get("checked")){var aM=aK[1];P.stopEvent(aM);this.widgets.linkBn.set("checked",false)}},scope:this,correctScope:true}).enable();var aG=new YAHOO.widget.ButtonGroup(aH+"-bg");for(var aE=0;aE<aG.getCount();aE++){aG.getButton(aE).addListener("click",aB,null,this)}this.widgets.linkDialogBg=aG;this.widgets.linkDialog=aJ;YAHOO.util.Event.addListener(aF,"click",function(){this.focus();this.select()})}if(this.widgets.searchBarToggle.get("checked")===true){this.widgets.searchBarToggle.set("checked",false)}if(!this.widgets.linkDialog.cfg.getProperty("visible")){this.widgets.linkDialog.show();this.widgets.linkDialog.bringToTop();aB.call(this)}else{this.widgets.linkDialog.hide()}},onRecalculatePreviewLayout:function ap(aB){if(this.documentView){Alfresco.logger.debug("onRecalculatePreviewLayout");this._setPreviewerElementHeight();this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.alignRows();this.documentView.renderVisiblePages()}if(this.thumbnailView){this.thumbnailView.renderVisiblePages()}},onWindowHashChange:function M(aC){if(this.disabledPageLinking){return}var aB=Alfresco.util.getQueryStringParameters(window.location.hash.replace("#",""));pn=aB.page;if(pn){if(pn>this.pdfDocument.numPages){pn=this.pdfDocument.numPages}else{if(pn<1){pn=1}}this.pageNum=parseInt(pn);this._scrollToPage(this.pageNum)}},onWindowUnload:function o(){if(this.attributes.useLocalStorage=="true"&&this._browserSupportsHtml5Storage()&&this.documentView){var aB="org.alfresco.pdfjs.document."+this.wp.options.nodeRef.replace(":/","").replace("/",".")+".";if(this.pageNum){window.localStorage[aB+"pageNum"]=this.pageNum}if(this.documentView.lastScale){window.localStorage[aB+"scale"]=this.documentView.lastScale}if(this.widgets.sidebarButton){window.localStorage[aB+"sidebar-enabled"]=this.widgets.sidebarButton.get("checked")}}}};var t=function(aF,aE,aD,aC,aB){this.id=aF;this.content=aE;this.parent=aD;this.canvas=null;this.container=null;this.loadingIconDiv=null;this.textLayerDiv=null;this.config=aC||{};this.textContent=null;this.textLayerDiv=null;this.pdfJsPlugin=aB};t.prototype={render:function B(){var aC=document.createElement("div");aC.id=this.parent.id+"-pageContainer-"+this.id;z.addClass(aC,"page");this.parent.viewer.appendChild(aC);var aB=document.createElement("div");z.addClass(aB,"loadingIcon");aC.appendChild(aB);this.container=aC;this.loadingIconDiv=aB;this._setPageSize()},getRegion:function j(){return z.getRegion(this.container)},getVPos:function ag(aB){return this.container.getBoundingClientRect().top+z.getDocumentScrollTop()-this.parent.viewerRegion.top},renderContent:function s(){var aL=this.getRegion(),aC=document.createElement("canvas");aC.id=this.container.id.replace("-pageContainer-","-canvas-");aC.mozOpaque=true;this.container.appendChild(aC);this.canvas=aC;z.setStyle(aC,"visibility","hidden");aC.width=aL.width;aC.height=aL.height;var aJ=this.content.getViewport(this.parent.currentScale);var aF=null;if(!this.parent.config.disableTextLayer){aF=document.createElement("div");aF.className="textLayer";this.container.appendChild(aF)}this.textLayerDiv=aF;this.textLayer=aF?new aj(aF,this.id-1,this.pdfJsPlugin,aJ):null;var aI=this.content,aM=aI.view,aN=aC.getContext("2d");var aD={canvasContext:aN,viewport:aJ,textLayer:this.textLayer};var aB=0;if(Alfresco.logger.isDebugEnabled()){aB=Date.now()}var aE=Alfresco.util.bind(function aG(aO){this.textLayer.setTextContent(aO)},this);var aH=Alfresco.util.bind(function aK(){if(this.textLayer){this.getTextContent().then(aE)}if(this.loadingIconDiv){z.setStyle(this.loadingIconDiv,"display","none")}z.setStyle(this.canvas,"visibility","visible");if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendered "+this.parent.name+" page "+this.id+" in "+(Date.now()-aB)+"ms")}},this);aI.render(aD).promise.then(aH)},_setPageSize:function F(aB){var aC=this.content.getViewport(this.parent.currentScale);z.setStyle(this.container,"height",Math.floor(aC.height)+"px");z.setStyle(this.container,"width",Math.floor(aC.width)+"px")},reset:function m(){this._setPageSize();if(this.canvas){this.container.removeChild(this.canvas);delete this.canvas;this.canvas=null}if(this.loadingIconDiv){z.setStyle(this.loadingIconDiv,"display","block")}},getTextContent:function E(){if(!this.textContent){this.textContent=this.content.getTextContent()}return this.textContent},scrollIntoView:function C(aC,aB){var aD=0;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll")}if(aC){aD+=aC.offsetTop;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll offsetTop "+aC.offsetTop)}}if(aB){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll spot "+aB.top)}aD+=aB.top}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll "+aD)}this.parent.scrollTo(this.id,aD)}};var H=function(aD,aC){this.id=aD;this.config=aC||{};this.pages=[];this.viewer=z.get(aD);this.viewerRegion=z.getRegion(this.viewer);this.currentScale=aC.currentScale||d;this.name=this.config.name||"";this.pdfJsPlugin=aC.pdfJsPlugin;this.pdfDocument=aC.pdfDocument;this.lastScroll=0;var aB=this;this.viewer.addEventListener("scroll",function(){aB.lastScroll=Date.now()},false);this.pdfJsPlugin.onResize.subscribe(this.onResize,this,true);this.addScrollListener();this.onScrollChange=new YAHOO.util.CustomEvent("scrollChange",this)};H.prototype={activePage:null,lastScale:null,renderOnScrollZero:0,addPage:function D(aD,aB){var aC=new t(aD,aB,this,{},this.pdfJsPlugin);this.pages.push(aC)},addPages:function I(aB){for(var aC=0;aC<aB.length;aC++){var aD=aB[aC];this.addPage(aC+1,aD)}},render:function O(){for(var aB=0;aB<this.pages.length;aB++){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering "+this.name+" page container "+(aB+1))}this.pages[aB].render()}if(this.currentScale===d){this.setScale(this.parseScale(this.config.defaultScale))}else{this.alignRows()}},reset:function av(){for(var aB=0;aB<this.pages.length;aB++){this.pages[aB].reset()}this.alignRows()},alignRows:function az(){var aB=-1,aE=0,aF=0,aI=z.getDocumentScrollTop();if(this.config.pageLayout=="multi"){z.setStyle(this.viewer,"padding-left","0px");for(var aG=0;aG<this.pages.length;aG++){var aH=this.pages[aG],aC=aH.container,aJ=aC.getBoundingClientRect(),aK=aJ.top+aI-aH.parent.viewerRegion.top,aD=parseInt(z.getStyle(aC,"margin-left"));if(aK!=aB){aE=aD}aE+=aJ.width+aD;aF=Math.max(aF,aE);aB=aK}z.setStyle(this.viewer,"padding-left",Math.floor((this.viewer.clientWidth-aF)/2)+"px")}},renderVisiblePages:function w(){this.viewerRegion=z.getRegion(this.viewer);var aJ=this.viewerRegion.height,aI=this.viewerRegion.top,aH=z.getDocumentScrollTop();if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Render "+this.name+" visible pages: viewer height "+this.viewerRegion.height+"px")}for(var aD=0;aD<this.pages.length;aD++){var aF=this.pages[aD];if(!aF.canvas){var aC=aF.container.getBoundingClientRect(),aG=aC.top+aH-aI,aB=aG+aC.height,aE=1.5;if(aG<0&&0<aB||-aJ*aE<aB&&aB<aJ||0<aG&&aG<aJ*(aE+1)){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering "+this.name+" page "+(aD+1)+" content (page top:"+aG+", bottom:"+aB+")")}aF.renderContent()}}}},scrollTo:function u(aF,aE){var aB=this.pages[aF-1].getVPos(),aD=this.pages[0].getVPos();if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Scrolling "+this.name+" to page "+aF+". New page top is "+aB+"px. First page top is "+aD+"px")}var aC=aB-aD;if(aE){aC+=aE}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Old scrollTop was "+this.viewer.scrollTop+"px");Alfresco.logger.debug("Set scrollTop to "+aC+"px");Alfresco.logger.debug("scrollTop offsetY "+aE)}this.viewer.scrollTop=aC;this.pageNum=aF;this.renderVisiblePages()},setScale:function ae(aB){if(aB==this.currentScale){return}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Scale is now "+aB)}this.currentScale=aB;this.reset();this.alignRows()},parseScale:function Z(aL){var aT=parseFloat(aL);if(aT){this.lastScale=aL;return aT}if(this.pages.length!==0){var aO=this.pages[0],aJ=aO.container,aG=parseInt(z.getStyle(aJ,"margin-left"))+parseInt(z.getStyle(aJ,"margin-right")),aI=parseInt(z.getStyle(aJ,"margin-top")),aK=parseInt(aO.content.pageInfo.view[2]),aN=parseInt(aO.content.pageInfo.view[3]),aM=aO.content.pageInfo.rotate,aQ=this.fullscreen?window.screen.width:this.viewer.clientWidth-1,aF=this.fullscreen?window.screen.height:this.viewer.clientHeight;Alfresco.logger.debug("Client height: "+this.viewer.clientHeight);if(aM===90||aM===270){var aS=aK;aK=aN;aN=aS}switch(aL){case"page-width":var aC=(aQ-aG*2)/aK;aT=aC;break;case"two-page-width":var aC=(aQ-aG*3)/aK;aT=aC/2;break;case"page-height":var aB=(aF-aI*2)/aN;aT=aB;break;case"page-fit":var aC=(aQ-aG*2)/aK,aB=(aF-aI*2)/aN;aT=Math.min(aC,aB);break;case"two-page-fit":var aC=(aQ-aG*3)/aK,aB=(aF-aI*2)/aN;aT=Math.min(aC/2,aB);break;case"auto":var aD=this.parseScale("two-page-fit"),aH=this.parseScale("page-fit"),aU=this.parseScale("page-width"),aP=this.parseScale("two-page-width"),aR=this.config.autoMinScale,aE=this.config.autoMaxScale;if(aD>aR&&this.numPages>1){aT=aD}else{if(aH>aR){aT=aH}else{if(aP>aR&&this.numPages>1){aT=aP}else{if(aU>aR){aT=aU}else{aT=aR}}}}if(aE){aT=Math.min(aT,aE)}break;default:throw"Unrecognised zoom level '"+aL+"'"}}else{throw"Unrecognised zoom level - no pages"}this.lastScale=aL;return aT},getScrolledPageNumber:function K(){for(var aB=0;aB<this.pages.length;aB++){var aC=this.pages[aB],aD=aC.getVPos();if(aD+parseInt(aC.container.style.height)/2>0){return aB+1}}return this.pages.length},setActivePage:function l(aB){if(this.activePage){z.removeClass(this.activePage.container,"activePage")}z.addClass(this.pages[aB-1].container,"activePage");this.activePage=this.pages[aB-1]},onResize:function G(){this.viewerRegion=z.getRegion(this.viewer)},addScrollListener:function x(){P.addListener(this.viewer,"scroll",this.onScrollEvent,this,true)},removeScrollListener:function x(){P.removeListener(this.viewer,"scroll",this.onScrollEvent)},onScrollEvent:function at(aB){this.renderOnScrollZero++;YAHOO.lang.later(50,this,this.onScroll,aB)},onScroll:function aA(aB){this.renderOnScrollZero--;if(this.renderOnScrollZero==0){this.renderVisiblePages();this.onScrollChange.fire(this)}}};var S=-50;var J=-400;var aj=function R(aH,aB,aK,aL){var aI=document.createDocumentFragment();this.textDivs=[];this.viewport=aL;this.textLayerDiv=aH;this.layoutDone=false;this.divContentDone=false;this.pageIdx=aB;this.matches=[];this.pdfJsPlugin=aK;this.isViewerInPresentationMode=false;if(typeof q==="undefined"){window.PDFFindController=null}if(typeof this.lastScrollSource==="undefined"){this.lastScrollSource=null}this.renderLayer=function aG(){var aT=this.textDivs;var aO=document.createElement("canvas");var aX=aO.getContext("2d");var aQ=100000;if(aT.length>aQ){return}for(var aS=0,aV=aT.length;aS<aV;aS++){var aR=aT[aS];if("isWhitespace" in aR.dataset){continue}aX.font=aR.style.fontSize+" "+aR.style.fontFamily;var aN=aX.measureText(aR.textContent).width;if(aN>0){aI.appendChild(aR);var aU=aR.dataset.canvasWidth/aN;var aW=aR.dataset.angle;var aP="scale("+aU+", 1)";aP="rotate("+aW+"deg) "+aP;z.setStyle(aR,"-ms-transform","scale("+aU+", 1)");z.setStyle(aR,"-webkit-transform","scale("+aU+", 1)");z.setStyle(aR,"-moz-transform","scale("+aU+", 1)");z.setStyle(aR,"-ms-transformOrigin","0% 0%");z.setStyle(aR,"-webkit-transformOrigin","0% 0%");z.setStyle(aR,"-moz-transformOrigin","0% 0%")}}this.textLayerDiv.appendChild(aI);this.renderingDone=true;this.updateMatches()};this.setupRenderLayoutTimer=function aM(){var aP=200;var aN=this;var aO=(this.lastScrollSource===null?0:this.lastScrollSource.lastScroll);if(Date.now()-aO>aP){this.renderLayer()}else{if(this.renderTimer){clearTimeout(this.renderTimer)}this.renderTimer=setTimeout(function(){aN.setupRenderLayoutTimer()},aP)}};this.appendText=function aC(aQ,aT){var aR=aT[aQ.fontName];var aO=document.createElement("div");this.textDivs.push(aO);if(!/\S/.test(aQ.str)){aO.dataset.isWhitespace=true;return}var aN=PDFJS.Util.transform(this.viewport.transform,aQ.transform);var aU=Math.atan2(aN[1],aN[0]);if(aR.vertical){aU+=Math.PI/2}var aS=Math.sqrt((aN[2]*aN[2])+(aN[3]*aN[3]));var aP=(aR.ascent?aR.ascent*aS:(aR.descent?(1+aR.descent)*aS:aS));aO.style.position="absolute";aO.style.left=(aN[4]+(aP*Math.sin(aU)))+"px";aO.style.top=(aN[5]-(aP*Math.cos(aU)))+"px";aO.style.fontSize=aS+"px";aO.style.fontFamily=aR.fontFamily;aO.textContent=aQ.str;aO.dataset.fontName=aQ.fontName;aO.dataset.angle=aU*(180/Math.PI);if(aR.vertical){aO.dataset.canvasWidth=aQ.height*this.viewport.scale}else{aO.dataset.canvasWidth=aQ.width*this.viewport.scale}};this.setTextContent=function aJ(aP){this.textContent=aP;var aO=aP.items;for(var aN=0;aN<aO.length;aN++){this.appendText(aO[aN],aP.styles)}this.divContentDone=true;this.setupRenderLayoutTimer()};this.convertMatches=function aD(aT){var aR=0;var aU=0;var aN=this.textContent.items;var aQ=aN.length-1;var aP=(q===null?0:q.state.query.length);var aV=[];for(var aO=0;aO<aT.length;aO++){var aW=aT[aO];while(aR!==aQ&&aW>=(aU+aN[aR].str.length)){aU+=aN[aR].str.length;aR++}if(aR==aN.length){console.error("Could not find matching mapping")}var aS={begin:{divIdx:aR,offset:aW-aU}};aW+=aP;while(aR!==aQ&&aW>(aU+aN[aR].str.length)){aU+=aN[aR].str.length;aR++}aS.end={divIdx:aR,offset:aW-aU};aV.push(aS)}return aV};this.renderMatches=function aF(aN){if(aN.length===0){return}var a2=this.textContent.items;var aX=this.textDivs;var aO=null;var aZ=(q===null?false:(this.pageIdx===q.selected.pageIdx));var a3=(q===null?-1:q.selected.matchIdx);var a4=(q===null?false:q.state.highlightAll);var aU={divIdx:-1,offset:undefined};function a7(a9,a8){var ba=a9.divIdx;var bb=aX[ba];bb.textContent="";aQ(ba,0,a9.offset,a8)}function a5(ba,a9,a8){aQ(ba.divIdx,ba.offset,a9.offset,a8)}function aQ(be,a9,a8,bb){var bf=aX[be];var bd=a2[be].str.substring(a9,a8);var bc=document.createTextNode(bd);if(bb){var ba=document.createElement("span");ba.className=bb;ba.appendChild(bc);bf.appendChild(ba);return}bf.appendChild(bc)}function aR(a9,a8){aX[a9].className=a8}var a0=a3,aY=a0+1,a1;if(a4){a0=0;aY=aN.length}else{if(!aZ){return}}for(a1=a0;a1<aY;a1++){var aS=aN[a1];var a6=aS.begin;var aP=aS.end;var aT=aZ&&a1===a3;var aW=(aT?" selected":"");if(aT&&!this.isViewerInPresentationMode){this.pdfJsPlugin.documentView.pages[this.pageIdx].scrollIntoView(aX[a6.divIdx],{top:S,left:J})}if(!aO||a6.divIdx!==aO.divIdx){if(aO!==null){a5(aO,aU)}a7(a6)}else{a5(aO,a6)}if(a6.divIdx===aP.divIdx){a5(a6,aP,"highlight"+aW)}else{a5(a6,aU,"highlight begin"+aW);for(var aV=a6.divIdx+1;aV<aP.divIdx;aV++){aR(aV,"highlight middle"+aW)}a7(aP,"highlight end"+aW)}aO=aP}if(aO){a5(aO,aU)}};this.updateMatches=function aE(){if(!this.renderingDone){return}var aS=this.matches;var aU=this.textDivs;var aO=this.textContent.items;var aV=-1;for(var aR=0;aR<aS.length;aR++){var aT=aS[aR];var aQ=Math.max(aV,aT.begin.divIdx);for(var aP=aQ;aP<=aT.end.divIdx;aP++){var aN=aU[aP];aN.textContent=aO[aP].str;aN.className=""}aV=aT.end.divIdx+1}if(q===null||!q.active){return}this.matches=aS=(this.convertMatches(q===null?[]:(q.pageMatches[this.pageIdx]||[])));this.renderMatches(this.matches)}};var ao={FIND_FOUND:0,FIND_NOTFOUND:1,FIND_WRAPPED:2,FIND_PENDING:3};var q={startedTextExtraction:false,extractTextPromises:[],pendingFindMatches:{},active:false,pageContents:[],pageMatches:[],selected:{pageIdx:-1,matchIdx:-1},offset:{pageIdx:null,matchIdx:null},resumePageIdx:null,state:null,dirtyMatch:false,findTimeout:null,pdfPageSource:null,integratedFind:false,initialize:function(aB){this.pdfPageSource=aB.pdfPageSource;this.integratedFind=aB.integratedFind;var aD=["find","findagain","findhighlightallchange","findcasesensitivitychange"];this.firstPagePromise=new Promise(function(aE){this.resolveFirstPage=aE}.bind(this));this.handleEvent=this.handleEvent.bind(this);for(var aC=0;aC<aD.length;aC++){window.addEventListener(aD[aC],this.handleEvent)}},reset:function ad(){this.startedTextExtraction=false;this.extractTextPromises=[];this.active=false},calcFindMatch:function(aC){var aF=this.pageContents[aC];var aH=this.state.query;var aD=this.state.caseSensitive;var aB=aH.length;if(aB===0){return}if(!aD){aF=aF.toLowerCase();aH=aH.toLowerCase()}var aG=[];var aE=-aB;while(true){aE=aF.indexOf(aH,aE+aB);if(aE===-1){break}aG.push(aE)}this.pageMatches[aC]=aG;this.updatePage(aC);if(this.resumePageIdx===aC){this.resumePageIdx=null;this.nextPageMatch()}},extractText:function(){if(this.startedTextExtraction){return}this.startedTextExtraction=true;this.pageContents=[];var aF=[];for(var aC=0,aD=this.pdfPageSource.pdfDocument.numPages;aC<aD;aC++){this.extractTextPromises.push(new Promise(function(aG){aF.push(aG)}))}var aB=this;function aE(aG){aB.pdfPageSource.pages[aG].getTextContent().then(function aH(aK){var aJ=aK.items;var aL="";for(var aI=0;aI<aJ.length;aI++){aL+=aJ[aI].str}aB.pageContents.push(aL);aF[aG](aG);if((aG+1)<aB.pdfPageSource.pages.length){aE(aG+1)}})}aE(0)},handleEvent:function(aB){if(this.state===null||aB.type!=="findagain"){this.dirtyMatch=true}this.state=aB.detail;this.updateUIState(ao.FIND_PENDING);this.firstPagePromise.then(function(){this.extractText();clearTimeout(this.findTimeout);if(aB.type==="find"){this.findTimeout=setTimeout(this.nextMatch.bind(this),250)}else{this.nextMatch()}}.bind(this))},updatePage:function(aB){var aC=this.pdfPageSource.pages[aB];if(this.selected.pageIdx===aB){aC.scrollIntoView()}if(aC.textLayer){aC.textLayer.updateMatches()}},nextMatch:function(){var aE=this.state.findPrevious;var aH=this.pdfPageSource.pageNum-1;var aC=this.pdfPageSource.pages.length;this.active=true;if(this.dirtyMatch){this.dirtyMatch=false;this.selected.pageIdx=this.selected.matchIdx=-1;this.offset.pageIdx=aH;this.offset.matchIdx=null;this.hadMatch=false;this.resumePageIdx=null;this.pageMatches=[];var aB=this;for(var aD=0;aD<aC;aD++){this.updatePage(aD);if(!(aD in this.pendingFindMatches)){this.pendingFindMatches[aD]=true;this.extractTextPromises[aD].then(function(aI){delete aB.pendingFindMatches[aI];aB.calcFindMatch(aI)})}}}if(this.state.query===""){this.updateUIState(ao.FIND_FOUND);return}if(this.resumePageIdx){return}var aG=this.offset;if(aG.matchIdx!==null){var aF=this.pageMatches[aG.pageIdx].length;if((!aE&&aG.matchIdx+1<aF)||(aE&&aG.matchIdx>0)){this.hadMatch=true;aG.matchIdx=aE?aG.matchIdx-1:aG.matchIdx+1;this.updateMatch(true);return}this.advanceOffsetPage(aE)}this.nextPageMatch()},matchesReady:function(aD){var aE=this.offset;var aC=aD.length;var aB=this.state.findPrevious;if(aC){this.hadMatch=true;aE.matchIdx=aB?aC-1:0;this.updateMatch(true);return true}else{this.advanceOffsetPage(aB);if(aE.wrapped){aE.matchIdx=null;if(!this.hadMatch){this.updateMatch(false);return true}}return false}},nextPageMatch:function(){if(this.resumePageIdx!==null){console.error("There can only be one pending page.")}do{var aB=this.offset.pageIdx;var aC=this.pageMatches[aB];if(!aC){this.resumePageIdx=aB;break}}while(!this.matchesReady(aC))},advanceOffsetPage:function(aC){var aD=this.offset;var aB=this.extractTextPromises.length;aD.pageIdx=aC?aD.pageIdx-1:aD.pageIdx+1;aD.matchIdx=null;if(aD.pageIdx>=aB||aD.pageIdx<0){aD.pageIdx=aC?aB-1:0;aD.wrapped=true;return}},updateMatch:function(aE){var aD=ao.FIND_NOTFOUND;var aC=this.offset.wrapped;this.offset.wrapped=false;if(aE){var aB=this.selected.pageIdx;this.selected.pageIdx=this.offset.pageIdx;this.selected.matchIdx=this.offset.matchIdx;aD=aC?ao.FIND_WRAPPED:ao.FIND_FOUND;if(aB!==-1&&aB!==this.selected.pageIdx){this.updatePage(aB)}}this.updateUIState(aD,this.state.findPrevious);if(this.selected.pageIdx!==-1){this.updatePage(this.selected.pageIdx,true)}},updateUIState:function(aE,aD){var aB="";var aC="";if(aE===ao.FIND_FOUND||aE===ao.FIND_PENDING){return}switch(aE){case ao.FIND_FOUND:aB=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.found");break;case ao.FIND_PENDING:aB=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.pending");break;case ao.FIND_NOTFOUND:aB=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.notfound");break;case ao.FIND_WRAPPED:if(aD){aB=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.wrapped.bottom")}else{aB=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.wrapped.top")}break}Alfresco.util.PopupManager.displayMessage({text:aB})}}})();